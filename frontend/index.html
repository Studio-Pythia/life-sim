<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dreamland</title>

  <style>
    :root{
      --bg:#000000;
      --panel:#000000;
      --ink:#00ff66;         /* terminal green */
      --muted:#00cc55;       /* softer green */
      --border:#00ff66;      /* green border */
      --accent:#66ff99;      /* link-ish green */
      --danger:#ff4d4d;      /* red error */
      --shadow: rgba(0,255,102,0.15);
    }

    *{ box-sizing:border-box; }

    body{
      margin:0;
      background:var(--bg);
      color:var(--ink);
      font-family: "Courier New", Courier, ui-monospace, Menlo, Monaco, Consolas;
      display:flex;
      align-items:center;
      justify-content:center;
      min-height:100vh;
      padding: max(14px, env(safe-area-inset-top)) max(14px, env(safe-area-inset-right))
              max(18px, env(safe-area-inset-bottom)) max(14px, env(safe-area-inset-left));
    }

    /* subtle CRT glow */
    body::before{
      content:"";
      position:fixed;
      inset:0;
      pointer-events:none;
      background:
        radial-gradient(circle at 50% 35%, rgba(0,255,102,0.08), transparent 55%),
        repeating-linear-gradient(
          0deg,
          rgba(0,255,102,0.035) 0px,
          rgba(0,255,102,0.035) 1px,
          transparent 2px,
          transparent 5px
        );
      mix-blend-mode: screen;
      opacity: .55;
    }

    .window{
      width: 100%;
      max-width: 980px;
      background:var(--panel);
      border:1px solid var(--border);
      padding:14px;
      min-height: min(92vh, 860px);
      display:flex;
      flex-direction:column;
      gap:12px;
      box-shadow: 0 0 0 1px rgba(0,255,102,0.25), 0 0 30px var(--shadow);
    }

    .top{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:end;
      border-bottom:1px solid var(--border);
      padding-bottom:12px;
      margin-bottom:0;
    }

    .field{
      flex:1;
      min-width:180px;
      display:flex;
      flex-direction:column;
      gap:6px;
    }

    label{
      font-size:12px;
      color:var(--muted);
      letter-spacing:0.4px;
      text-transform:uppercase;
    }

    input, select{
      padding:12px;
      border:1px solid var(--border);
      background:#000;
      color:var(--ink);
      font-family: inherit;
      font-size:16px; /* prevents iOS zoom */
      outline:none;
      box-shadow: inset 0 0 0 1px rgba(0,255,102,0.10);
    }

    input::placeholder{
      color: rgba(0,255,102,0.45);
    }

    input:focus, select:focus{
      box-shadow: 0 0 0 2px rgba(0,255,102,0.25);
    }

    .startBtn{
      padding:14px 12px;
      border:1px solid var(--border);
      background:#000;
      cursor:pointer;
      font-family: inherit;
      text-decoration:underline;
      color:var(--ink);
      width: min(220px, 100%);
    }

    .startBtn:hover{
      background: rgba(0,255,102,0.06);
    }

    .hud{
      display:flex;
      justify-content:space-between;
      align-items:baseline;
      gap:10px;
      margin-top:2px;
      flex-wrap:wrap;
    }

    .age{
      font-size: clamp(34px, 8vw, 52px);
      font-weight:800;
      text-shadow: 0 0 12px rgba(0,255,102,0.18);
    }

    .meta{
      font-size:12px;
      color:var(--muted);
      text-align:right;
      max-width:100%;
      opacity:.85;
      text-transform:uppercase;
      letter-spacing:.5px;
    }

    .story{
      border-top:1px solid var(--border);
      padding-top:14px;
      min-height:180px;
      font-size:18px;
      line-height:1.75;
      letter-spacing:.1px;
      white-space:pre-wrap;
    }

    .cursor{
      display:inline-block;
      width:8px;
      margin-left:3px;
      animation: blink 0.9s steps(1) infinite;
      color:var(--ink);
    }

    @keyframes blink{
      50%{ opacity:0; }
    }

    .choices{
      margin-top:4px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    .choiceBtn{
      width:100%;
      padding:18px 16px;
      border:1px solid var(--border);
      background:#000;
      cursor:pointer;
      font-family: inherit;
      text-align:left;
      font-size:16px;
      line-height:1.3;
      touch-action: manipulation;
      color:var(--ink);
    }

    .choiceBtn:hover{ background: rgba(0,255,102,0.06); }
    .choiceBtn:disabled{ opacity:.35; cursor:not-allowed; }

    .error{
      margin-top:8px;
      color:var(--danger);
      font-size:13px;
    }

    /* Loading overlay -> bottom sheet */
    .overlay{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.78);
      display:flex;
      align-items:flex-end;
      justify-content:center;
      z-index:9999;
      padding: 0 14px max(14px, env(safe-area-inset-bottom)) 14px;
    }

    .overlayBox{
      border:1px solid var(--border);
      background:#000;
      padding:14px 16px;
      font-size:14px;
      width:100%;
      max-width:980px;
      box-shadow: 0 0 18px rgba(0,255,102,0.18);
    }

    .overlayTitle{
      font-weight:700;
      margin-bottom:8px;
      text-decoration:underline;
      color:var(--ink);
    }

    .hidden{
      display:none !important;
      pointer-events:none !important;
    }

    .loaderRow{
      display:flex;
      align-items:center;
      gap:10px;
      margin-top:6px;
      color:var(--muted);
    }

    .spinner{
      width:14px;
      height:14px;
      border:2px solid var(--ink);
      border-top-color: transparent;
      border-radius:999px;
      animation: spin .8s linear infinite;
    }

    @keyframes spin{
      to{ transform: rotate(360deg); }
    }

    .dots::after{
      content:"";
      display:inline-block;
      width:14px;
      text-align:left;
      animation: dots 1.2s steps(4,end) infinite;
    }

    @keyframes dots{
      0%{ content:""; }
      25%{ content:"."; }
      50%{ content:".."; }
      75%{ content:"..."; }
      100%{ content:""; }
    }

    #playAgain{
      text-align:center;
      font-weight:800;
      letter-spacing:1.2px;
      text-transform:uppercase;
    }

    /* Mobile */
    @media (max-width: 640px){
      .top{
        display:grid;
        grid-template-columns:1fr;
        gap:10px;
        align-items:stretch;
      }
      .field{ min-width:0; }
      .startBtn{ width:100%; }

      .hud{
        flex-direction:column;
        align-items:flex-start;
        gap:6px;
      }
      .meta{ text-align:left; }

      .story{
        font-size:17px;
        min-height:160px;
      }
    }
  </style>
</head>

<body>
  <!-- ✅ Add this modal HTML right after <body> opens (above .window) -->
<div class="overlay" id="intro">
  <div class="overlayBox">
    <div class="overlayTitle">DREAMLAND</div>
    <div style="line-height:1.55; color: var(--muted);">
      This is a life simulator.<br><br>
      Enter anything you want at the top (gender, city, what you want to become).<br><br>
      Then simulate your life through key moments: every screen gives you two choices that can redirect your timeline.<br><br>
      Play as many times as you want. Different inputs create different lives.<br><br>
      -R
    </div>

    <div style="display:flex; gap:10px; margin-top:14px; flex-wrap:wrap;">
      <button class="choiceBtn" id="introStart" type="button" style="text-align:center; font-weight:800;">
        OK — LET ME IN
      </button>
      <button class="choiceBtn" id="introClose" type="button" style="text-align:center; opacity:.9;">
        CLOSE
      </button>
    </div>
  </div>
</div>

<style>
  /* ✅ add this to your CSS (keeps intro modal centered not bottom-sheet) */
  #intro{
    align-items:center !important;
  }
  #intro .overlayBox{
    max-width:720px !important;
  }
</style>

<script>
  // ✅ Add this inside your <script> block (near DOMContentLoaded)

  function hideIntro(){
    const intro = document.getElementById("intro");
    if(intro) intro.classList.add("hidden");
    localStorage.setItem("lifeSimIntroSeen", "1");
  }

  window.addEventListener("DOMContentLoaded", () => {
    const seen = localStorage.getItem("lifeSimIntroSeen");
    const intro = document.getElementById("intro");
    const introStart = document.getElementById("introStart");
    const introClose = document.getElementById("introClose");

    // show every time (remove this if you only want it once)
    if(intro) intro.classList.remove("hidden");

    introStart?.addEventListener("click", () => {
      hideIntro();
      // optional: focus first input
      document.getElementById("city")?.focus();
    });

    introClose?.addEventListener("click", hideIntro);
  });
</script>
  <div class="window" id="window">

    <div class="top" id="onboarding">
      <div class="field">
        <label>Gender</label>
        <select id="gender">
          <option value="female">female</option>
          <option value="male">male</option>
        </select>
      </div>

      <div class="field">
        <label>City of birth</label>
        <input id="city" placeholder="e.g. Chicago" />
      </div>

      <div class="field">
        <label>I want to become…</label>
        <input id="desire" placeholder="e.g. famous / rich / free / a basketball player" />
      </div>

      <button class="startBtn" id="start" type="button">Start Life</button>
    </div>

    <div class="hud">
      <div class="age" id="age">Age: 0</div>
      <div class="meta" id="meta">CHOOSE WISELY</div>
    </div>

    <div class="story" id="story">
      Fill in info and Press Start Life above.<span class="cursor">█</span>
    </div>

    <div class="choices">
      <button class="choiceBtn" id="a" disabled>A</button>
      <button class="choiceBtn" id="b" disabled>B</button>
      <button class="choiceBtn hidden" id="playAgain" type="button">PLAY AGAIN</button>
    </div>

    <div class="error" id="error" style="display:none;"></div>
  </div>

  <div class="overlay hidden" id="loading">
    <div class="overlayBox">
      <div class="overlayTitle">Loading<span class="dots"></span></div>
      <div class="loaderRow">
        <div class="spinner"></div>
        <div class="loaderMsg">Generating next life moment<span class="dots"></span></div>
      </div>
    </div>
  </div>

<script>
  // ✅ Your backend URL
  const API_BASE = "https://life-sim-production.up.railway.app";

  function newRunId(){
    if (window.crypto && crypto.randomUUID) return crypto.randomUUID();
    return String(Date.now()) + "-" + Math.random().toString(16).slice(2);
  }

  function getSessionId(){
    const key = "lifeSimSessionId";
    let id = localStorage.getItem(key);
    if(!id){
      id = newRunId();
      localStorage.setItem(key, id);
    }
    return id;
  }

  const state = {
    session_id: getSessionId(),
    run_id: newRunId(),
    age: 0,
    gender: "unspecified",
    city: "",
    desire: "",
    stats: { money:.5, stability:.5, status:.5, health:.5, stress:.5, freedom:.5, exposure:.5 },
    relationships: [],
    history: []
  };

  let currentScenario = null;
  let locked = false;

  const el = {
    gender: document.getElementById("gender"),
    city: document.getElementById("city"),
    desire: document.getElementById("desire"),
    start: document.getElementById("start"),
    age: document.getElementById("age"),
    meta: document.getElementById("meta"),
    story: document.getElementById("story"),
    a: document.getElementById("a"),
    b: document.getElementById("b"),
    playAgain: document.getElementById("playAgain"),
    error: document.getElementById("error"),
    loading: document.getElementById("loading"),
    loadingMsg: document.querySelector(".loaderMsg"),
    onboarding: document.getElementById("onboarding")
  };

  const loadLines = [
    "Generating next life moment…",
    "Calculating consequences…",
    "Locking the timeline…",
    "Spooling the next decade…",
    "Loading the moment…"
  ];
  let loadTimer = null;

  function showPlayAgain(on){
    if(on) el.playAgain.classList.remove("hidden");
    else el.playAgain.classList.add("hidden");
  }

  function setError(msg){
    if(!msg){
      el.error.style.display = "none";
      el.error.textContent = "";
      return;
    }
    el.error.style.display = "block";
    el.error.textContent = msg;
  }

  function setLoading(on){
    locked = on;
    if(on){
      el.loading.classList.remove("hidden");
      let i = 0;
      el.loadingMsg.textContent = loadLines[i];
      loadTimer = setInterval(() => {
        i = (i + 1) % loadLines.length;
        el.loadingMsg.textContent = loadLines[i];
      }, 350);
    } else {
      el.loading.classList.add("hidden");
      if(loadTimer) clearInterval(loadTimer);
      loadTimer = null;
    }
  }

  function setButtonsDisabled(disabled){
    el.a.disabled = disabled;
    el.b.disabled = disabled;
  }

  function sleep(ms){ return new Promise(r => setTimeout(r, ms)); }

  async function typewriter(text, speed=14){
    setButtonsDisabled(true);

    const cursor = `<span class="cursor">█</span>`;
    el.story.innerHTML = cursor;

    let out = "";
    for(let i=0;i<text.length;i++){
      out += text[i];
      el.story.innerHTML = out.replaceAll("\n", "<br>") + cursor;
      await sleep(speed);
    }

    el.story.innerHTML = out.replaceAll("\n", "<br>") + cursor;
    setButtonsDisabled(false);
  }

  async function apiTurn(){
    const r = await fetch(API_BASE + "/api/turn", {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ state })
    });

    const json = await r.json().catch(()=> null);
    if(!r.ok){
      throw new Error(json?.message || "turn_failed");
    }
    return json;
  }

  async function apiApply(effects){
    const r = await fetch(API_BASE + "/api/apply", {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({
        age: state.age,
        stats: state.stats,
        effects,
        death_cause_hint: currentScenario?.death_cause_hint || ""
      })
    });

    const json = await r.json().catch(()=> null);
    if(!r.ok) throw new Error(json?.error || "apply_failed");
    return json;
  }

  async function apiEpilogue(cause){
    const r = await fetch(API_BASE + "/api/epilogue", {
      method: "POST",
      headers: { "Content-Type":"application/json" },
      body: JSON.stringify({
        age: state.age,
        gender: state.gender,
        city: state.city,
        desire: state.desire,
        relationships: state.relationships || [],
        history: state.history.slice(-30),
        cause
      })
    });

    const json = await r.json().catch(()=> null);
    if(!r.ok) throw new Error(json?.error || "epilogue_failed");
    return json;
  }

  function renderChoices(scenario){
    el.a.textContent = scenario.options[0].label;
    el.b.textContent = scenario.options[1].label;
  }

  function resetGameUI(){
    currentScenario = null;
    locked = false;

    state.run_id = newRunId();
    state.age = 0;
    state.history = [];
    state.relationships = [];
    state.stats = { money:.5, stability:.5, status:.5, health:.5, stress:.5, freedom:.5, exposure:.5 };

    el.age.textContent = "Age: 0";
    el.meta.textContent = "CHOOSE WISELY";
    el.story.innerHTML = `Fill in info and Press Start Life above.<span class="cursor">█</span>`;

    el.a.textContent = "A";
    el.b.textContent = "B";

    setButtonsDisabled(true);
    showPlayAgain(false);
    setError("");
    setLoading(false);
  }

  async function startGame(){
    showPlayAgain(false);
    setError("");

    state.run_id = newRunId();
    state.age = 0;
    state.history = [];
    state.relationships = [];
    state.stats = { money:.5, stability:.5, status:.5, health:.5, stress:.5, freedom:.5, exposure:.5 };

    state.gender = (el.gender.value || "unspecified").trim();
    state.city = (el.city.value || "").trim();
    state.desire = (el.desire.value || "").trim();

    if(!state.city || !state.desire){
      setError("Enter a city and what you want to be.");
      return;
    }

    el.meta.textContent = `${state.city.toUpperCase()} • I WANT TO BE ${state.desire.toUpperCase()}`;

    setLoading(true);
    setButtonsDisabled(true);

    try{
      const data = await apiTurn();

      if (data.birth_stats) state.stats = data.birth_stats;
      if (data.relationships && data.relationships.length === 3) state.relationships = data.relationships;

      state.age = data.age_to;
      currentScenario = data.scenario;

      el.age.textContent = `Age: ${state.age}`;
      renderChoices(currentScenario);

      setLoading(false);
      await typewriter(currentScenario.text, 14);

    }catch(e){
      setLoading(false);
      setError("Start failed: " + (e.message || "Model error"));
      setButtonsDisabled(true);
    }
  }

  async function choose(index){
    if(locked || !currentScenario) return;

    setError("");
    setLoading(true);
    setButtonsDisabled(true);

    try{
      const chosen = currentScenario.options[index];
      state.history.push(chosen.label);

      const applied = await apiApply(chosen.effects || {});
      state.stats = applied.next_stats;

      if(applied.died){
        setLoading(false);

        const cause = (currentScenario.death_cause_hint || "complications").trim() || "complications";
        let endingText = `You die at ${state.age}. Cause: ${cause}.`;

        try{
          const ep = await apiEpilogue(cause);
          endingText = ep?.text || endingText;
        }catch(_){}

        // ✅ death screen changes are FRONTEND-only:
        // - Age header becomes RIP AGE: X
        // - choice buttons vanish
        el.age.textContent = `RIP AGE: ${state.age}`;
        el.a.classList.add("hidden");
        el.b.classList.add("hidden");

        await typewriter(endingText, 14);
        showPlayAgain(true);
        return;
      }

      const next = await apiTurn();

      if (next.relationships && next.relationships.length === 3) state.relationships = next.relationships;

      state.age = next.age_to;
      currentScenario = next.scenario;

      el.age.textContent = `Age: ${state.age}`;
      renderChoices(currentScenario);

      setLoading(false);
      await typewriter(currentScenario.text, 14);

    }catch(e){
      setLoading(false);
      setError("Turn failed: " + (e.message || "bad_request"));
      setButtonsDisabled(false);
    }
  }

  // handlers
  window.addEventListener("DOMContentLoaded", () => {
    el.start.addEventListener("click", (e) => {
      e.preventDefault();
      startGame();
    });

    el.a.addEventListener("click", () => choose(0));
    el.b.addEventListener("click", () => choose(1));

    el.playAgain.addEventListener("click", () => {
      // bring choice buttons back for next run
      el.a.classList.remove("hidden");
      el.b.classList.remove("hidden");
      resetGameUI();
    });
  });
</script>
</body>
</html>
