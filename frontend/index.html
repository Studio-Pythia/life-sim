<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>Dreamland</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/phaser/3.60.0/phaser.min.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');

    :root {
      --bg: #1a1a2e;
      --panel: #0f0f1a;
      --ink: #e8e8e8;
      --muted: #8888aa;
      --border: #3a3a5c;
      --accent: #5dade2;
      --highlight: #f9e547;
      --danger: #e74c3c;
      --dialogue-bg: #0a0a18;
      --dialogue-border: #4a4a7c;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      background: var(--bg);
      color: var(--ink);
      font-family: 'Press Start 2P', monospace;
      overflow: hidden;
      width: 100vw;
      height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      image-rendering: pixelated;
    }

    #game-wrapper {
      position: relative;
      width: 100%;
      max-width: 960px;
      aspect-ratio: 16/10;
      max-height: 100vh;
      background: #000;
      overflow: hidden;
      border: 3px solid var(--border);
      box-shadow: 0 0 40px rgba(93,173,226,0.15), inset 0 0 60px rgba(0,0,0,0.5);
    }

    #phaser-canvas { width: 100%; height: 100%; display: block; }
    #phaser-canvas canvas { width: 100% !important; height: 100% !important; }

    #ui-overlay {
      position: absolute; inset: 0;
      pointer-events: none;
      display: flex; flex-direction: column; justify-content: flex-end;
      z-index: 10;
    }

    #hud {
      position: absolute; top: 0; left: 0; right: 0;
      display: flex; justify-content: space-between; align-items: center;
      padding: 8px 12px;
      background: linear-gradient(180deg, rgba(10,10,24,0.92) 0%, rgba(10,10,24,0.6) 80%, transparent 100%);
      font-size: 10px; z-index: 20;
    }

    #hud-age {
      font-size: 14px; color: var(--highlight);
      text-shadow: 0 0 8px rgba(249,229,71,0.4);
    }

    #hud-meta {
      color: var(--muted); font-size: 8px; text-align: right;
      max-width: 50%; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
    }

    #hud-relations {
      position: absolute; top: 36px; right: 12px;
      display: flex; flex-direction: column; gap: 4px; z-index: 20;
    }

    .rel-chip {
      display: flex; align-items: center; gap: 6px;
      background: rgba(10,10,24,0.85); border: 1px solid var(--border);
      padding: 3px 8px 3px 4px; font-size: 7px; color: var(--muted);
    }

    .rel-icon {
      width: 18px; height: 18px; border: 1px solid var(--border);
      image-rendering: pixelated;
    }

    #dialogue-area {
      pointer-events: auto; padding: 0 8px 8px 8px;
      display: flex; flex-direction: column; gap: 6px;
    }

    #dialogue-box {
      background: var(--dialogue-bg); border: 3px solid var(--dialogue-border);
      border-radius: 4px; padding: 14px 16px;
      min-height: 100px; max-height: 160px; overflow-y: auto;
      font-size: 11px; line-height: 1.8; color: var(--ink);
      text-shadow: 0 1px 2px rgba(0,0,0,0.5);
      box-shadow: 0 -4px 20px rgba(0,0,0,0.5);
    }

    #dialogue-box::-webkit-scrollbar { width: 4px; }
    #dialogue-box::-webkit-scrollbar-track { background: transparent; }
    #dialogue-box::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

    #dialogue-text { white-space: pre-wrap; }

    .cursor-blink {
      display: inline-block; width: 8px; height: 12px;
      background: var(--ink); animation: blink 0.8s steps(1) infinite;
      vertical-align: middle; margin-left: 2px;
    }

    @keyframes blink { 50% { opacity: 0; } }

    #choices { display: flex; gap: 6px; }

    .choice-btn {
      flex: 1; background: var(--dialogue-bg); border: 2px solid var(--dialogue-border);
      border-radius: 3px; padding: 10px 12px;
      font-family: 'Press Start 2P', monospace; font-size: 9px; line-height: 1.5;
      color: var(--ink); cursor: pointer; text-align: left;
      transition: all 0.15s; position: relative; pointer-events: auto;
    }

    .choice-btn::before {
      content: '▶'; position: absolute; left: 4px; top: 50%;
      transform: translateY(-50%); opacity: 0;
      color: var(--highlight); font-size: 8px; transition: opacity 0.15s;
    }

    .choice-btn:hover {
      border-color: var(--highlight); background: rgba(249,229,71,0.08);
      padding-left: 18px; box-shadow: 0 0 12px rgba(249,229,71,0.15);
    }

    .choice-btn:hover::before { opacity: 1; }

    .choice-btn:disabled {
      opacity: 0.3; cursor: not-allowed; pointer-events: none;
    }

    #play-again { display: none; pointer-events: auto; }

    #play-again button {
      width: 100%; background: var(--dialogue-bg); border: 2px solid var(--highlight);
      border-radius: 3px; padding: 14px;
      font-family: 'Press Start 2P', monospace; font-size: 11px;
      color: var(--highlight); cursor: pointer; text-align: center;
      letter-spacing: 2px; transition: all 0.2s;
    }

    #play-again button:hover {
      background: rgba(249,229,71,0.12); box-shadow: 0 0 20px rgba(249,229,71,0.2);
    }

    /* ── Onboarding ── */
    #onboarding-overlay {
      position: absolute; inset: 0;
      background: rgba(10,10,24,0.95); z-index: 100;
      display: flex; align-items: center; justify-content: center;
      pointer-events: auto;
    }

    #onboarding-box {
      max-width: 420px; width: 90%;
      display: flex; flex-direction: column; gap: 12px;
    }

    #onboarding-box h1 {
      font-size: 20px; color: var(--highlight);
      text-shadow: 0 0 16px rgba(249,229,71,0.3);
      letter-spacing: 4px; text-align: center; margin-bottom: 4px;
    }

    #onboarding-box p {
      font-size: 8px; color: var(--muted); line-height: 1.8; text-align: center;
    }

    .ob-field { display: flex; flex-direction: column; gap: 4px; }

    .ob-field label {
      font-size: 8px; color: var(--muted); letter-spacing: 1px; text-transform: uppercase;
    }

    .ob-field select, .ob-field input {
      padding: 10px; background: var(--panel); border: 2px solid var(--border);
      border-radius: 3px; color: var(--ink);
      font-family: 'Press Start 2P', monospace; font-size: 10px; outline: none;
    }

    .ob-field input::placeholder { color: rgba(136,136,170,0.5); }
    .ob-field input:focus, .ob-field select:focus { border-color: var(--accent); }

    #start-btn {
      margin-top: 4px; padding: 14px; background: transparent;
      border: 2px solid var(--highlight); border-radius: 3px;
      color: var(--highlight); font-family: 'Press Start 2P', monospace;
      font-size: 10px; cursor: pointer; letter-spacing: 2px; transition: all 0.2s;
    }

    #start-btn:hover {
      background: rgba(249,229,71,0.1); box-shadow: 0 0 20px rgba(249,229,71,0.15);
    }

    /* ── Stat overlay ── */
    #stat-overlay {
      position: absolute; inset: 0;
      background: rgba(10,10,24,0.92); z-index: 50;
      display: none; align-items: center; justify-content: center;
      pointer-events: auto;
    }

    #stat-card {
      background: var(--dialogue-bg); border: 3px solid var(--dialogue-border);
      border-radius: 6px; padding: 20px; max-width: 360px; width: 85%;
    }

    #stat-card h2 {
      font-size: 12px; color: var(--highlight); margin-bottom: 14px;
      text-align: center; letter-spacing: 2px;
    }

    .stat-row { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; }

    .stat-label {
      font-size: 7px; color: var(--muted); width: 70px;
      text-transform: uppercase; letter-spacing: 0.5px;
    }

    .stat-bar-bg {
      flex: 1; height: 8px; background: rgba(255,255,255,0.08);
      border-radius: 2px; overflow: hidden;
    }

    .stat-bar-fill { height: 100%; border-radius: 2px; transition: width 0.5s ease; }
    .stat-val { font-size: 7px; color: var(--ink); width: 28px; text-align: right; }

    #stat-close {
      margin-top: 14px; width: 100%; padding: 10px;
      background: transparent; border: 2px solid var(--border); border-radius: 3px;
      color: var(--muted); font-family: 'Press Start 2P', monospace;
      font-size: 8px; cursor: pointer;
    }

    #stat-close:hover { border-color: var(--ink); color: var(--ink); }

    #stat-toggle {
      position: absolute; top: 6px; left: 50%; transform: translateX(-50%);
      z-index: 25; background: rgba(10,10,24,0.7);
      border: 1px solid var(--border); border-radius: 3px;
      padding: 3px 10px; font-family: 'Press Start 2P', monospace;
      font-size: 7px; color: var(--muted); cursor: pointer;
      pointer-events: auto; transition: all 0.15s;
    }

    #stat-toggle:hover { color: var(--highlight); border-color: var(--highlight); }

    /* ── Loading ── */
    #loading-overlay {
      position: absolute; inset: 0; background: rgba(0,0,0,0.75);
      z-index: 200; display: none; align-items: center; justify-content: center;
      flex-direction: column; gap: 12px; pointer-events: auto;
    }

    .lds-ring { width: 32px; height: 32px; position: relative; }
    .lds-ring div {
      width: 26px; height: 26px; border: 3px solid var(--accent);
      border-color: var(--accent) transparent transparent transparent;
      border-radius: 50%; position: absolute;
      animation: lds-ring 1s cubic-bezier(0.5,0,0.5,1) infinite;
    }
    @keyframes lds-ring { to { transform: rotate(360deg); } }

    #loading-text { font-size: 9px; color: var(--muted); }

    /* ── Transition ── */
    #transition-overlay {
      position: absolute; inset: 0; background: #000; z-index: 150;
      display: none; align-items: center; justify-content: center;
      opacity: 0; pointer-events: none;
    }

    #transition-text { font-size: 14px; color: var(--ink); letter-spacing: 3px; }

    /* ── Error ── */
    #error-bar {
      position: absolute; bottom: 0; left: 0; right: 0;
      background: rgba(231,76,60,0.9); padding: 8px 12px;
      font-size: 8px; color: #fff; z-index: 300; display: none;
      pointer-events: auto;
    }

    #error-bar a { color: var(--highlight); cursor: pointer; text-decoration: underline; }

    /* ── Responsive ── */
    @media (max-width: 640px) {
      #game-wrapper { border-width: 2px; aspect-ratio: auto; height: 100vh; max-height: 100vh; }
      #hud { padding: 6px 8px; }
      #hud-age { font-size: 11px; }
      #dialogue-box { font-size: 9px; min-height: 80px; max-height: 120px; padding: 10px 12px; }
      .choice-btn { font-size: 8px; padding: 8px 10px; }
      .rel-chip { font-size: 6px; }
      .rel-icon { width: 14px; height: 14px; }
      #onboarding-box h1 { font-size: 16px; }
      #stat-toggle { font-size: 6px; }
    }

    @media (max-height: 500px) {
      #dialogue-box { min-height: 60px; max-height: 90px; }
    }
  </style>
</head>
<body>

<div id="game-wrapper">
  <div id="phaser-canvas"></div>

  <div id="ui-overlay">
    <div id="hud">
      <div id="hud-age">AGE 0</div>
      <div id="hud-meta"></div>
    </div>
    <button id="stat-toggle">STATS</button>
    <div id="hud-relations"></div>

    <div id="dialogue-area">
      <div id="dialogue-box">
        <span id="dialogue-text"></span><span class="cursor-blink"></span>
      </div>
      <div id="choices">
        <button class="choice-btn" id="btn-a" disabled>A</button>
        <button class="choice-btn" id="btn-b" disabled>B</button>
      </div>
      <div id="play-again"><button>▶ PLAY AGAIN</button></div>
    </div>
  </div>

  <div id="onboarding-overlay">
    <div id="onboarding-box">
      <h1>DREAMLAND</h1>
      <p>A life simulator. Enter your starting conditions, then navigate key moments through choices that reshape your timeline.</p>
      <div class="ob-field">
        <label>Gender</label>
        <select id="gender"><option value="female">Female</option><option value="male">Male</option></select>
      </div>
      <div class="ob-field">
        <label>City of birth</label>
        <input id="city" placeholder="e.g. Chicago" />
      </div>
      <div class="ob-field">
        <label>I want to become…</label>
        <input id="desire" placeholder="e.g. famous / rich / a musician" />
      </div>
      <button id="start-btn">START LIFE</button>
    </div>
  </div>

  <div id="stat-overlay">
    <div id="stat-card">
      <h2>LIFE STATS</h2>
      <div id="stat-bars"></div>
      <button id="stat-close">CLOSE [ESC]</button>
    </div>
  </div>

  <div id="loading-overlay">
    <div class="lds-ring"><div></div></div>
    <div id="loading-text">Generating life moment…</div>
  </div>

  <div id="transition-overlay">
    <div id="transition-text"></div>
  </div>

  <div id="error-bar"></div>
</div>

<script>
// ═══════════════════════════════════════════════
// DREAMLAND — Phase 1+2: Phaser Scene + RPG UI
// ═══════════════════════════════════════════════

const API_BASE = "https://life-sim-production.up.railway.app";

// ── Palettes for pixel art scenes ──
const PALETTES = {
  nursery:    ['#2d1b4e','#8b6d4a','#d4a574','#f2c6de','#c9a0dc','#f7d08a','#7ec8e3','#fff4c1'],
  school:     ['#4a90d9','#6b8e4e','#c4a882','#e8d5b7','#8b7355','#f5c542','#5dade2','#ffffff'],
  bedroom:    ['#1a1a3e','#3d2b5a','#6b4d8a','#9b6dba','#4a4a7c','#e8a0c9','#7ec8e3','#f9e547'],
  apartment:  ['#2c3e50','#8b6d4a','#bdc3c7','#e0d5c0','#6b4d3a','#f39c12','#3498db','#ecf0f1'],
  office:     ['#1a2530','#4a4a4a','#7f8c8d','#bdc3c7','#34495e','#e67e22','#2980b9','#ecf0f1'],
  home:       ['#2d4a1a','#8b6d4a','#d4a574','#e8d5b7','#6b4d3a','#f7d08a','#7ec8e3','#fff4c1'],
  hospital:   ['#e8f0f5','#c5d5e0','#9bb0c0','#ffffff','#708090','#e74c3c','#5dade2','#f0f0f0'],
  death:      ['#0a0a0a','#1a1a1a','#2a2a2a','#3a3a3a','#4a4a4a','#5a5a5a','#333333','#666666'],
};

function getSceneType(age, stats) {
  if (age <= 5)  return 'nursery';
  if (age <= 12) return 'school';
  if (age <= 18) return 'bedroom';
  if (age <= 25) return 'apartment';
  if (age <= 55) {
    if (stats.health < 0.2) return 'hospital';
    return stats.money > 0.6 ? 'home' : 'office';
  }
  if (stats.health < 0.3) return 'hospital';
  return 'home';
}

// ── Phaser Scene ──
class LifeScene extends Phaser.Scene {
  constructor() { super({ key: 'LifeScene' }); }

  create() {
    this.tileSize = 16;
    this.scaleF = 3;
    this.currentType = 'nursery';
    this.particles = [];
    this.renderScene('nursery', { money:.5,stability:.5,status:.5,health:.5,stress:.5,freedom:.5,exposure:.5 }, 0);
    this.time.addEvent({ delay: 80, callback: () => this.animateParticles(), loop: true });
  }

  renderScene(type, stats, age) {
    this.currentType = type;
    const pal = PALETTES[type] || PALETTES.nursery;
    this.children.removeAll(true);
    this.tweens.killAll();
    this.particles = [];

    const W = this.cameras.main.width;
    const H = this.cameras.main.height;
    const T = this.tileSize * this.scaleF;

    // ── Sky gradient ──
    const skyGfx = this.add.graphics();
    const c1 = Phaser.Display.Color.HexStringToColor(pal[0]);
    const c2 = Phaser.Display.Color.HexStringToColor(pal[1]);
    for (let y = 0; y < H; y++) {
      const t = y / H;
      skyGfx.fillStyle(Phaser.Display.Color.GetColor(
        Phaser.Math.Linear(c1.red, c2.red, t),
        Phaser.Math.Linear(c1.green, c2.green, t),
        Phaser.Math.Linear(c1.blue, c2.blue, t)
      ), 1);
      skyGfx.fillRect(0, y, W, 1);
    }

    const floorY = H * 0.65;

    // ── Floor with checkerboard ──
    const floorGfx = this.add.graphics();
    floorGfx.fillStyle(Phaser.Display.Color.HexStringToColor(pal[1]).color, 1);
    floorGfx.fillRect(0, floorY, W, H - floorY);
    const floorDark = Phaser.Display.Color.HexStringToColor(pal[4]).color;
    for (let x = 0; x < W; x += T) {
      for (let y = floorY; y < H; y += T) {
        if ((Math.floor(x/T) + Math.floor(y/T)) % 2 === 0) {
          floorGfx.fillStyle(floorDark, 0.15);
          floorGfx.fillRect(x, y, T, T);
        }
      }
    }

    // ── Back wall with brick texture ──
    const wallGfx = this.add.graphics();
    wallGfx.fillStyle(Phaser.Display.Color.HexStringToColor(pal[2]).color, 1);
    wallGfx.fillRect(0, H*0.15, W, floorY - H*0.15);
    const wlc = Phaser.Display.Color.HexStringToColor(pal[4]).color;
    wallGfx.lineStyle(1, wlc, 0.12);
    for (let y = H*0.15; y < floorY; y += T) wallGfx.lineBetween(0, y, W, y);
    for (let x = 0; x < W; x += T*2) {
      const off = (Math.floor(x/T/2) % 2) * T;
      wallGfx.lineBetween(x+off, H*0.15, x+off, floorY);
    }

    // Ceiling trim
    const ceil = this.add.graphics();
    ceil.fillStyle(Phaser.Display.Color.HexStringToColor(pal[4]).color, 0.5);
    ceil.fillRect(0, H*0.14, W, 6);

    // ── Window ──
    this.drawWindow(W*0.12, H*0.22, T*2, T*2.5, pal, age);

    // ── Furniture ──
    this.drawFurniture(type, stats, age, pal, W, H, T, floorY);

    // ── Character ──
    this.drawCharacter(age, stats, W*0.5, floorY, T, pal);

    // ── Particles ──
    this.setupParticles(type, stats, W, H);

    // ── Vignette edges ──
    const vig = this.add.graphics();
    vig.fillStyle(0x000000, 0.3);
    vig.fillRect(0, 0, 8, H);
    vig.fillRect(W-8, 0, 8, H);
    vig.fillStyle(0x000000, 0.15);
    vig.fillRect(0, 0, W, 4);

    if (type === 'death') {
      const d = this.add.graphics();
      d.fillStyle(0x000000, 0.5);
      d.fillRect(0, 0, W, H);
    }
  }

  drawWindow(x, y, w, h, pal, age) {
    const gfx = this.add.graphics();
    const col = (i) => Phaser.Display.Color.HexStringToColor(pal[i]).color;
    gfx.fillStyle(col(4), 1);
    gfx.fillRect(x-3, y-3, w+6, h+6);
    const hour = (age * 7 + 10) % 24;
    const sky = hour < 6 || hour > 20 ? '#0a0a2e' : hour < 8 || hour > 18 ? '#e8835a' : '#87ceeb';
    gfx.fillStyle(Phaser.Display.Color.HexStringToColor(sky).color, 1);
    gfx.fillRect(x, y, w, h);
    gfx.fillStyle(col(4), 1);
    gfx.fillRect(x + w/2 - 2, y, 4, h);
    gfx.fillRect(x, y + h/2 - 2, w, 4);
    gfx.fillStyle(Phaser.Display.Color.HexStringToColor(sky).color, 0.15);
    gfx.fillRect(x-10, y+h, w+20, 40);
  }

  drawFurniture(type, stats, age, pal, W, H, T, floorY) {
    const gfx = this.add.graphics();
    const col = (i) => Phaser.Display.Color.HexStringToColor(pal[i]).color;

    switch(type) {
      case 'nursery': {
        gfx.fillStyle(col(5), 1);
        gfx.fillRect(W*0.65, floorY-T*1.8, T*2.5, T*1.8);
        gfx.fillStyle(col(3), 1);
        gfx.fillRect(W*0.65+4, floorY-T*1.5, T*2.5-8, T*1.2);
        gfx.lineStyle(2, col(5), 0.6);
        for (let i = 0; i < 6; i++) gfx.lineBetween(W*0.65+8+i*18, floorY-T*1.8, W*0.65+8+i*18, floorY-T*0.6);
        gfx.fillStyle(col(6), 1);
        gfx.fillRect(W*0.35, floorY-12, 14, 12);
        gfx.fillStyle(col(7), 1);
        gfx.fillRect(W*0.38, floorY-10, 8, 8);
        gfx.fillStyle(col(3), 0.25);
        gfx.fillEllipse(W*0.5, floorY+T*0.8, T*4, T*1.2);
        break;
      }
      case 'school': {
        gfx.fillStyle(col(4), 1);
        gfx.fillRect(W*0.55, floorY-T*1.2, T*3, T*0.2);
        gfx.fillRect(W*0.55+6, floorY-T*1, 6, T*1);
        gfx.fillRect(W*0.55+T*3-12, floorY-T*1, 6, T*1);
        gfx.fillStyle(col(6), 1);
        gfx.fillRect(W*0.62, floorY-T*1.5, 20, 14);
        gfx.fillStyle(0x2d4a2d, 1);
        gfx.fillRect(W*0.35, H*0.2, T*4, T*2);
        gfx.lineStyle(3, col(5), 0.6);
        gfx.strokeRect(W*0.35, H*0.2, T*4, T*2);
        // Chalk marks
        gfx.lineStyle(1, 0xffffff, 0.3);
        gfx.lineBetween(W*0.38, H*0.28, W*0.48, H*0.28);
        gfx.lineBetween(W*0.38, H*0.34, W*0.52, H*0.34);
        break;
      }
      case 'bedroom': {
        gfx.fillStyle(col(4), 1);
        gfx.fillRect(W*0.6, floorY-T*1, T*3, T*1);
        gfx.fillStyle(col(3), 1);
        gfx.fillRect(W*0.6+4, floorY-T*0.8, T*3-8, T*0.5);
        gfx.fillStyle(col(7), 0.8);
        gfx.fillRect(W*0.6+8, floorY-T*0.75, 24, 16);
        gfx.fillStyle(col(4), 1);
        gfx.fillRect(W*0.6, floorY-T*1.8, 8, T*1.8);
        // Poster
        gfx.fillStyle(col(5), 1);
        gfx.fillRect(W*0.3, H*0.25, T*1.5, T*2);
        gfx.fillStyle(col(6), 0.6);
        gfx.fillRect(W*0.3+6, H*0.25+6, T*1.5-12, T*2-12);
        // Desk lamp glow
        gfx.fillStyle(col(7), 0.08);
        gfx.fillEllipse(W*0.75, floorY-T*1.4, T*2, T*1.5);
        break;
      }
      case 'apartment': {
        const nice = stats.money > 0.5;
        gfx.fillStyle(col(nice?6:4), 1);
        gfx.fillRect(W*0.55, floorY-T*1.2, T*3.5, T*0.8);
        gfx.fillStyle(col(nice?6:4), 0.5);
        gfx.fillRect(W*0.55, floorY-T*2, T*3.5, T*0.4);
        gfx.fillStyle(col(4), 1);
        gfx.fillRect(W*0.32, floorY-T*0.9, T*1.8, T*0.15);
        gfx.fillRect(W*0.38, floorY-T*0.75, 6, T*0.75);
        if (nice) {
          gfx.fillStyle(0x4a7a3a, 1);
          gfx.fillEllipse(W*0.28, floorY-T*1.2, 22, 28);
          gfx.fillStyle(col(4), 1);
          gfx.fillRect(W*0.28-6, floorY-T*0.8, 12, 16);
        }
        break;
      }
      case 'office': {
        gfx.fillStyle(col(4), 1);
        gfx.fillRect(W*0.45, floorY-T*1.2, T*4, T*0.2);
        gfx.fillRect(W*0.45+8, floorY-T*1, 6, T*1);
        gfx.fillRect(W*0.45+T*4-14, floorY-T*1, 6, T*1);
        gfx.fillStyle(0x222222, 1);
        gfx.fillRect(W*0.55, floorY-T*2.4, T*2, T*1.1);
        gfx.fillStyle(col(6), 0.5);
        gfx.fillRect(W*0.55+4, floorY-T*2.3, T*2-8, T*0.9);
        gfx.fillStyle(0x222222, 1);
        gfx.fillRect(W*0.62, floorY-T*1.3, 12, T*0.2);
        gfx.fillStyle(col(2), 0.8);
        gfx.fillRect(W*0.82, floorY-T*2, T*1, T*2);
        gfx.lineStyle(1, 0x000000, 0.2);
        gfx.lineBetween(W*0.82, floorY-T*1.3, W*0.82+T*1, floorY-T*1.3);
        gfx.lineBetween(W*0.82, floorY-T*0.6, W*0.82+T*1, floorY-T*0.6);
        break;
      }
      case 'home': {
        const nice = stats.money > 0.5;
        gfx.fillStyle(col(nice?5:4), 1);
        gfx.fillRect(W*0.5, floorY-T*1.2, T*4, T*0.8);
        gfx.fillStyle(col(nice?5:4), 0.6);
        gfx.fillRect(W*0.5, floorY-T*1.8, T*4, T*0.6);
        gfx.fillStyle(col(4), 1);
        gfx.fillRect(W*0.35, floorY-T*0.7, T*2, T*0.12);
        gfx.fillRect(W*0.38, floorY-T*0.58, 5, T*0.58);
        // Bookshelf
        gfx.fillStyle(col(4), 1);
        gfx.fillRect(W*0.82, H*0.2, T*1.2, floorY-H*0.2);
        for (let s = 0; s < 3; s++) {
          gfx.fillStyle(col(4), 0.8);
          gfx.fillRect(W*0.82, H*0.2+s*T*1.2, T*1.2, 4);
          for (let b = 0; b < 4; b++) {
            gfx.fillStyle([col(3),col(5),col(6),col(7)][b], 0.8);
            gfx.fillRect(W*0.82+4+b*12, H*0.2+s*T*1.2+6, 10, T*1-4);
          }
        }
        if (nice) {
          gfx.fillStyle(col(5), 1);
          gfx.fillRect(W*0.3, H*0.25, T*1.5, T*1.2);
          gfx.fillStyle(col(6), 0.4);
          gfx.fillRect(W*0.3+5, H*0.25+5, T*1.5-10, T*1.2-10);
        }
        break;
      }
      case 'hospital': {
        gfx.fillStyle(col(4), 1);
        gfx.fillRect(W*0.4, floorY-T*0.8, T*4, T*0.8);
        gfx.fillStyle(col(3), 1);
        gfx.fillRect(W*0.4+4, floorY-T*0.6, T*4-8, T*0.35);
        gfx.fillStyle(col(3), 0.8);
        gfx.fillRect(W*0.4+8, floorY-T*0.55, 30, 14);
        gfx.fillStyle(col(4), 1);
        gfx.fillRect(W*0.4, floorY-T*1.4, 6, T*1.4);
        gfx.lineStyle(2, col(4), 0.8);
        gfx.lineBetween(W*0.78, floorY-T*3, W*0.78, floorY);
        gfx.lineStyle(2, col(4), 0.6);
        gfx.lineBetween(W*0.76, floorY-T*3, W*0.80, floorY-T*3);
        gfx.fillStyle(col(6), 0.5);
        gfx.fillRect(W*0.77, floorY-T*2.8, 10, 16);
        gfx.fillStyle(0x222233, 1);
        gfx.fillRect(W*0.82, floorY-T*2, T*1.2, T*0.9);
        // Heartbeat
        gfx.lineStyle(1, 0x4ade80, 0.8);
        const mx = W*0.82+6, my = floorY-T*1.6;
        gfx.beginPath(); gfx.moveTo(mx, my);
        for (let i = 0; i < 40; i++) {
          let py = my;
          if (i%10===5) py -= 8;
          if (i%10===6) py += 6;
          gfx.lineTo(mx+i*1.2, py);
        }
        gfx.strokePath();
        break;
      }
    }
  }

  drawCharacter(age, stats, x, floorY, T, pal) {
    const gfx = this.add.graphics();
    const h = age<6 ? T*1 : age<13 ? T*1.4 : age<60 ? T*1.8 : T*1.5;
    const cy = floorY - h;
    const head = age<6 ? 14 : age<13 ? 12 : 10;

    // Head
    gfx.fillStyle(Phaser.Display.Color.HexStringToColor('#d4a574').color, 1);
    gfx.fillEllipse(x, cy+head, head, head);

    // Body
    const bw = age<6 ? 12 : age<13 ? 14 : 16;
    const bh = h - head*2;
    const bc = pal[age<13 ? 3 : age<30 ? 6 : 5];
    gfx.fillStyle(Phaser.Display.Color.HexStringToColor(bc).color, 1);
    gfx.fillRect(x-bw/2, cy+head*1.5, bw, bh);

    // Legs
    gfx.fillStyle(Phaser.Display.Color.HexStringToColor(pal[4]).color, 1);
    gfx.fillRect(x-bw/2+2, cy+head*1.5+bh, bw/2-3, h*0.2);
    gfx.fillRect(x+1, cy+head*1.5+bh, bw/2-3, h*0.2);

    // Hair
    gfx.fillStyle(age>55 ? 0xbbbbbb : 0x3a2a1a, 1);
    gfx.fillEllipse(x, cy+head*0.6, head+2, head*0.7);

    // Eyes
    gfx.fillStyle(0x222222, 1);
    gfx.fillRect(x-4, cy+head-1, 2, 2);
    gfx.fillRect(x+2, cy+head-1, 2, 2);

    // Idle bob
    this.tweens.add({
      targets: gfx, y: -2,
      duration: 1200, yoyo: true, repeat: -1, ease: 'Sine.easeInOut'
    });
  }

  setupParticles(type, stats, W, H) {
    if (type !== 'death') {
      for (let i = 0; i < 8; i++) {
        const p = this.add.graphics();
        p.fillStyle(0xffffff, Phaser.Math.FloatBetween(0.05, 0.15));
        p.fillCircle(0, 0, Phaser.Math.Between(1, 3));
        p.x = Phaser.Math.Between(0, W);
        p.y = Phaser.Math.Between(0, H*0.6);
        this.particles.push({ gfx:p, vx:Phaser.Math.FloatBetween(-0.3,0.3), vy:Phaser.Math.FloatBetween(0.1,0.4), maxY:H });
      }
    }
    if (stats.stress > 0.7) {
      for (let i = 0; i < 20; i++) {
        const r = this.add.graphics();
        r.lineStyle(1, 0x7ec8e3, 0.3);
        r.lineBetween(0, 0, -2, 8);
        r.x = Phaser.Math.Between(0, W);
        r.y = Phaser.Math.Between(-20, H);
        this.particles.push({ gfx:r, vx:-1, vy:6, maxY:H+20, wrap:true });
      }
    }
  }

  animateParticles() {
    const W = this.cameras.main.width;
    for (const p of this.particles) {
      p.gfx.x += p.vx;
      p.gfx.y += p.vy;
      if (p.gfx.y > p.maxY) { p.gfx.y = -10; if (p.wrap) p.gfx.x = Phaser.Math.Between(0, W); }
      if (p.gfx.x < -10) p.gfx.x = W+10;
      if (p.gfx.x > W+10) p.gfx.x = -10;
    }
  }
}

// ═══════════════════════════════════════════════
// Game State + API (same as Phase 0)
// ═══════════════════════════════════════════════

function newRunId() {
  if (window.crypto?.randomUUID) return crypto.randomUUID();
  return Date.now()+'-'+Math.random().toString(16).slice(2);
}
function getSessionId() {
  let id = localStorage.getItem('lifeSimSessionId');
  if (!id) { id = newRunId(); localStorage.setItem('lifeSimSessionId', id); }
  return id;
}

const state = {
  session_id: getSessionId(), run_id: newRunId(), age: 0,
  gender:'unspecified', city:'', desire:'',
  stats: { money:.5,stability:.5,status:.5,health:.5,stress:.5,freedom:.5,exposure:.5 },
  relationships: [], history: []
};

let currentScenario = null, locked = false, phaserGame = null, lastFailedAction = null;

const $ = id => document.getElementById(id);
const el = {
  hudAge:$('hud-age'), hudMeta:$('hud-meta'), hudRelations:$('hud-relations'),
  dialogueText:$('dialogue-text'), dialogueBox:$('dialogue-box'),
  btnA:$('btn-a'), btnB:$('btn-b'), playAgain:$('play-again'),
  onboarding:$('onboarding-overlay'), startBtn:$('start-btn'),
  gender:$('gender'), city:$('city'), desire:$('desire'),
  statOverlay:$('stat-overlay'), statBars:$('stat-bars'),
  statClose:$('stat-close'), statToggle:$('stat-toggle'),
  loading:$('loading-overlay'), loadingText:$('loading-text'),
  transition:$('transition-overlay'), transitionText:$('transition-text'),
  errorBar:$('error-bar'),
};

const loadLines = ['Generating life moment…','Calculating consequences…','Locking the timeline…','Spooling the next decade…','Loading the moment…'];
let loadTimer = null;

function setLoading(on) {
  locked = on;
  if (on) {
    el.loading.style.display = 'flex'; let i = 0;
    el.loadingText.textContent = loadLines[i];
    loadTimer = setInterval(() => { i=(i+1)%loadLines.length; el.loadingText.textContent=loadLines[i]; }, 400);
  } else {
    el.loading.style.display = 'none';
    if (loadTimer) clearInterval(loadTimer);
  }
}

function setError(msg) {
  if (!msg) { el.errorBar.style.display='none'; return; }
  el.errorBar.innerHTML = msg;
  el.errorBar.style.display = 'block';
  setTimeout(() => { el.errorBar.style.display='none'; }, 8000);
}

function setButtonsDisabled(d) { el.btnA.disabled=d; el.btnB.disabled=d; }

function playTransition(text) {
  return new Promise(resolve => {
    el.transition.style.display = 'flex';
    el.transitionText.textContent = text;
    el.transition.style.opacity = '0';
    let op = 0;
    const fi = setInterval(() => {
      op += 0.05;
      el.transition.style.opacity = String(Math.min(op,1));
      if (op >= 1) {
        clearInterval(fi);
        setTimeout(() => {
          const fo = setInterval(() => {
            op -= 0.04;
            el.transition.style.opacity = String(Math.max(op,0));
            if (op <= 0) { clearInterval(fo); el.transition.style.display='none'; resolve(); }
          }, 30);
        }, 800);
      }
    }, 30);
  });
}

function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }

async function typewriter(text, speed = 18) {
  setButtonsDisabled(true);
  const cursor = el.dialogueBox.querySelector('.cursor-blink');
  el.dialogueText.textContent = '';
  if (cursor) cursor.style.display = 'inline-block';
  for (let i = 0; i < text.length; i++) {
    el.dialogueText.textContent += text[i];
    el.dialogueBox.scrollTop = el.dialogueBox.scrollHeight;
    await sleep(speed);
  }
  setButtonsDisabled(false);
}

function showTextInstant(text) {
  el.dialogueText.textContent = text;
  el.dialogueBox.scrollTop = el.dialogueBox.scrollHeight;
}

function renderRelations(rels) {
  el.hudRelations.innerHTML = '';
  if (!rels?.length) return;
  const colors = ['#e74c3c','#3498db','#2ecc71'];
  rels.forEach((r, i) => {
    if (!r?.name) return;
    const chip = document.createElement('div');
    chip.className = 'rel-chip';
    const icon = document.createElement('canvas');
    icon.className = 'rel-icon'; icon.width=18; icon.height=18;
    const ctx = icon.getContext('2d');
    ctx.fillStyle = colors[i%3]; ctx.fillRect(0,0,18,18);
    ctx.fillStyle = '#d4a574'; ctx.fillRect(5,3,8,8);
    ctx.fillStyle = colors[i%3]; ctx.fillRect(3,10,12,8);
    const lbl = document.createElement('span');
    lbl.textContent = r.display || `${r.name} (${r.role})`;
    chip.appendChild(icon); chip.appendChild(lbl);
    el.hudRelations.appendChild(chip);
  });
}

const STAT_COLORS = {
  money:'#f9e547', stability:'#5dade2', status:'#9b59b6',
  health:'#4ade80', stress:'#e74c3c', freedom:'#1abc9c', exposure:'#e67e22'
};
const STAT_KEYS = ['money','stability','status','health','stress','freedom','exposure'];

function renderStatBars() {
  el.statBars.innerHTML = '';
  STAT_KEYS.forEach(k => {
    const val = Math.round((state.stats[k]||0.5)*100);
    const row = document.createElement('div'); row.className = 'stat-row';
    row.innerHTML = `<span class="stat-label">${k}</span><div class="stat-bar-bg"><div class="stat-bar-fill" style="width:${val}%;background:${STAT_COLORS[k]}"></div></div><span class="stat-val">${val}%</span>`;
    el.statBars.appendChild(row);
  });
}

function updateScene(isDeath = false) {
  const scene = phaserGame?.scene?.scenes?.[0];
  if (!scene) return;
  scene.renderScene(isDeath ? 'death' : getSceneType(state.age, state.stats), state.stats, state.age);
}

// ── API ──
async function apiTurn() {
  const r = await fetch(API_BASE+'/api/turn', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({state}) });
  const j = await r.json().catch(()=>null);
  if (!r.ok) throw new Error(j?.message||'turn_failed');
  return j;
}

async function apiApply(effects) {
  const r = await fetch(API_BASE+'/api/apply', { method:'POST', headers:{'Content-Type':'application/json'},
    body:JSON.stringify({ age:state.age, stats:state.stats, effects, death_cause_hint:currentScenario?.death_cause_hint||'' })
  });
  const j = await r.json().catch(()=>null);
  if (!r.ok) throw new Error(j?.error||'apply_failed');
  return j;
}

async function apiEpilogue(cause) {
  const r = await fetch(API_BASE+'/api/epilogue', { method:'POST', headers:{'Content-Type':'application/json'},
    body:JSON.stringify({ age:state.age, gender:state.gender, city:state.city, desire:state.desire,
      relationships:state.relationships||[], history:state.history.slice(-30), cause })
  });
  const j = await r.json().catch(()=>null);
  if (!r.ok) throw new Error(j?.error||'epilogue_failed');
  return j;
}

function logEvent(event, data={}) {
  fetch(API_BASE+'/api/analytics', { method:'POST', headers:{'Content-Type':'application/json'},
    body:JSON.stringify({ event, session_id:state.session_id, run_id:state.run_id, ...data })
  }).catch(()=>{});
}

function saveSession() {
  try { sessionStorage.setItem('dreamlandState', JSON.stringify({ state:{...state}, scenario:currentScenario, ts:Date.now() })); } catch {}
}
function clearSave() { try { sessionStorage.removeItem('dreamlandState'); } catch {} }

function restoreSession() {
  try {
    const raw = sessionStorage.getItem('dreamlandState');
    if (!raw) return false;
    const saved = JSON.parse(raw);
    if (Date.now()-saved.ts > 2*60*60*1000) { clearSave(); return false; }
    Object.assign(state, saved.state);
    currentScenario = saved.scenario;
    return true;
  } catch { return false; }
}

// ── Game flow ──
async function startGame() {
  setError('');
  state.run_id = newRunId(); state.age = 0; state.history = []; state.relationships = [];
  state.stats = { money:.5,stability:.5,status:.5,health:.5,stress:.5,freedom:.5,exposure:.5 };
  state.gender = (el.gender.value||'unspecified').trim();
  state.city = (el.city.value||'').trim();
  state.desire = (el.desire.value||'').trim();

  if (!state.city || !state.desire) { setError('Enter a city and what you want to become.'); return; }

  el.onboarding.style.display = 'none';
  el.hudMeta.textContent = `${state.city.toUpperCase()} · ${state.desire.toUpperCase()}`;
  el.playAgain.style.display = 'none';
  el.btnA.style.display = ''; el.btnB.style.display = '';
  setLoading(true); setButtonsDisabled(true);

  try {
    const data = await apiTurn();
    if (data.birth_stats) state.stats = data.birth_stats;
    if (data.relationships?.length === 3) state.relationships = data.relationships;
    state.age = data.age_to;
    currentScenario = data.scenario;
    el.hudAge.textContent = `AGE ${state.age}`;
    el.btnA.textContent = currentScenario.options[0].label;
    el.btnB.textContent = currentScenario.options[1].label;
    renderRelations(state.relationships); renderStatBars(); updateScene(); saveSession();
    logEvent('game_start', { city:state.city, desire:state.desire, gender:state.gender });
    setLoading(false);
    await typewriter(currentScenario.text, 18);
  } catch (e) {
    setLoading(false);
    lastFailedAction = startGame;
    setError(`Start failed: ${e.message} — <a onclick="retryLast()">RETRY</a>`);
    setButtonsDisabled(true);
  }
}

async function choose(index) {
  if (locked || !currentScenario) return;
  setError(''); setLoading(true); setButtonsDisabled(true);

  try {
    const chosen = currentScenario.options[index];
    state.history.push(chosen.label);
    logEvent('choice', { age:state.age, choice:index, label:chosen.label });

    const applied = await apiApply(chosen.effects||{});
    state.stats = applied.next_stats;

    if (applied.died) {
      setLoading(false);
      const cause = (currentScenario.death_cause_hint||'complications').trim()||'complications';
      await playTransition(`AGE ${state.age}`);

      let endingText = `You die at ${state.age}. Cause: ${cause}.`;
      try { const ep = await apiEpilogue(cause); endingText = ep?.text||endingText; } catch {}

      el.hudAge.textContent = `✝ AGE ${state.age}`;
      el.btnA.style.display = 'none'; el.btnB.style.display = 'none';
      updateScene(true); clearSave();
      logEvent('death', { age:state.age, cause });
      await typewriter(endingText, 22);
      el.playAgain.style.display = 'block';
      return;
    }

    const prevAge = state.age;
    const next = await apiTurn();
    if (next.relationships?.length === 3) state.relationships = next.relationships;
    state.age = next.age_to;
    currentScenario = next.scenario;

    setLoading(false);
    const diff = state.age - prevAge;
    await playTransition(diff > 0 ? `${diff} YEARS LATER...` : `AGE ${state.age}`);

    el.hudAge.textContent = `AGE ${state.age}`;
    el.btnA.textContent = currentScenario.options[0].label;
    el.btnB.textContent = currentScenario.options[1].label;
    renderRelations(state.relationships); renderStatBars(); updateScene(); saveSession();
    await typewriter(currentScenario.text, 18);
  } catch (e) {
    setLoading(false);
    lastFailedAction = () => choose(index);
    setError(`Turn failed: ${e.message} — <a onclick="retryLast()">RETRY</a>`);
    setButtonsDisabled(false);
  }
}

window.retryLast = function() { if (lastFailedAction) lastFailedAction(); };

function resetGame() {
  currentScenario = null; locked = false;
  state.run_id = newRunId(); state.age = 0; state.history = []; state.relationships = [];
  state.stats = { money:.5,stability:.5,status:.5,health:.5,stress:.5,freedom:.5,exposure:.5 };
  el.hudAge.textContent = 'AGE 0'; el.hudMeta.textContent = '';
  el.hudRelations.innerHTML = ''; el.dialogueText.textContent = '';
  el.btnA.textContent = 'A'; el.btnB.textContent = 'B';
  el.btnA.style.display = ''; el.btnB.style.display = '';
  setButtonsDisabled(true); el.playAgain.style.display = 'none';
  el.onboarding.style.display = 'flex';
  setError(''); setLoading(false); clearSave(); updateScene();
}

// ── Init ──
window.addEventListener('DOMContentLoaded', () => {
  phaserGame = new Phaser.Game({
    type: Phaser.AUTO,
    parent: 'phaser-canvas',
    width: 960, height: 600,
    backgroundColor: '#1a1a2e',
    scale: { mode: Phaser.Scale.FIT, autoCenter: Phaser.Scale.CENTER_BOTH },
    scene: [LifeScene],
    pixelArt: true, antialias: false, roundPixels: true,
  });

  el.startBtn.addEventListener('click', e => { e.preventDefault(); startGame(); });
  el.btnA.addEventListener('click', () => choose(0));
  el.btnB.addEventListener('click', () => choose(1));
  el.playAgain.querySelector('button').addEventListener('click', resetGame);

  el.statToggle.addEventListener('click', () => { renderStatBars(); el.statOverlay.style.display='flex'; });
  el.statClose.addEventListener('click', () => { el.statOverlay.style.display='none'; });

  document.addEventListener('keydown', e => {
    if (e.key==='Escape') el.statOverlay.style.display='none';
    if (el.onboarding.style.display!=='none') return;
    if (e.key==='1'||e.key==='a') el.btnA.click();
    if (e.key==='2'||e.key==='b') el.btnB.click();
    if (e.key==='s'||e.key==='S') el.statToggle.click();
  });

  if (restoreSession()) {
    el.onboarding.style.display = 'none';
    el.hudAge.textContent = `AGE ${state.age}`;
    el.hudMeta.textContent = `${state.city.toUpperCase()} · ${state.desire.toUpperCase()}`;
    renderRelations(state.relationships); renderStatBars(); updateScene();
    if (currentScenario) {
      showTextInstant(currentScenario.text);
      el.btnA.textContent = currentScenario.options[0].label;
      el.btnB.textContent = currentScenario.options[1].label;
      setButtonsDisabled(false);
    }
  }
});
</script>
</body>
</html>
