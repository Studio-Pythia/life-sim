<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Life Simulator</title>

  <style>
    :root{
      --bg:#f6f6f6;
      --ink:#111;
      --muted:#444;
      --border:#111;
      --panel:#fff;
      --danger:#b00020;
    }

    *{ box-sizing:border-box; }

    body{
      margin:0;
      background:var(--bg);
      color:var(--ink);
      font-family: "Courier New", Courier, ui-monospace, Menlo, Monaco, Consolas;
      display:flex;
      align-items:center;
      justify-content:center;
      min-height:100vh;
      padding:24px;
    }

    .window{
      width:min(980px, 96vw);
      background:var(--panel);
      border:1px solid var(--border);
      padding:18px 18px 22px;
    }

    .top{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:end;
      border-bottom:1px solid var(--border);
      padding-bottom:12px;
      margin-bottom:12px;
    }

    .field{
      flex:1;
      min-width:180px;
      display:flex;
      flex-direction:column;
      gap:6px;
    }

    label{
      font-size:12px;
      color:var(--muted);
      line-height:1.2;
    }

    input, select{
      padding:10px;
      border:1px solid var(--border);
      background:#fff;
      font-family: inherit;
      font-size:14px;
    }

    .startBtn{
      padding:10px 12px;
      border:1px solid var(--border);
      background:#fff;
      cursor:pointer;
      font-family: inherit;
      text-decoration:underline;
    }

    .startBtn:hover{
      background:#f0f0f0;
    }

    .hud{
      display:flex;
      justify-content:space-between;
      align-items:baseline;
      gap:10px;
      margin-top:8px;
      margin-bottom:10px;
    }

    .age{
      font-size:44px;
      font-weight:700;
    }

    .meta{
      font-size:12px;
      color:var(--muted);
      text-align:right;
      max-width:45%;
      line-height:1.35;
    }

    .story{
      margin-top:10px;
      border-top:1px solid var(--border);
      padding-top:16px;
      padding-bottom:8px;
      min-height:170px;

      /* better spacing */
      font-size:18px;
      line-height:1.55;
      letter-spacing:0.1px;

      white-space:pre-wrap;
    }

    .cursor{
      display:inline-block;
      width:10px;
      margin-left:3px;
      animation: blink 0.9s steps(1) infinite;
    }

    @keyframes blink{
      50%{ opacity:0; }
    }

    .choices{
      margin-top:14px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    .choiceBtn{
      width:100%;
      padding:14px 14px;
      border:1px solid var(--border);
      background:#fff;
      cursor:pointer;
      font-family: inherit;
      text-align:left;
      font-size:16px;
      line-height:1.35;
    }

    .choiceBtn:hover{ background:#f0f0f0; }
    .choiceBtn:disabled{ opacity:.35; cursor:not-allowed; }

    .error{
      margin-top:10px;
      color:var(--danger);
      font-size:13px;
      line-height:1.35;
    }

    /* Loading overlay */
    .overlay{
      position:fixed;
      inset:0;
      background:rgba(255,255,255,.85);
      display:flex;
      align-items:center;
      justify-content:center;
      z-index:9999;
    }
/* Loader */
.loaderRow{
  display:flex;
  align-items:center;
  gap:10px;
  margin-top:6px;
}

.spinner{
  width:14px;
  height:14px;
  border:2px solid #111;
  border-top-color: transparent;
  border-radius:999px;
  animation: spin .8s linear infinite;
}

@keyframes spin{
  to{ transform: rotate(360deg); }
}

.dots::after{
  content:"";
  display:inline-block;
  width:14px;
  text-align:left;
  animation: dots 1.2s steps(4,end) infinite;
}

@keyframes dots{
  0%{ content:""; }
  25%{ content:"."; }
  50%{ content:".."; }
  75%{ content:"..."; }
  100%{ content:""; }
	}

    .overlayBox{
      border:1px solid var(--border);
      background:#fff;
      padding:14px 16px;
      font-size:14px;
      width:min(520px, 92vw);
      line-height:1.35;
    }

    .overlayTitle{
      font-weight:700;
      margin-bottom:8px;
      text-decoration:underline;
    }

    .hidden{ display:none !important; }

	  /* ---------- Mobile-first improvements ---------- */

body{
  padding: max(14px, env(safe-area-inset-top)) max(14px, env(safe-area-inset-right))
           max(18px, env(safe-area-inset-bottom)) max(14px, env(safe-area-inset-left));
}

/* Make the "window" behave like an app screen */
.window{
  width: 100%;
  max-width: 980px;
  border: 1px solid var(--border);
  background: var(--panel);
  padding: 14px;
  min-height: min(92vh, 860px);
  display: flex;
  flex-direction: column;
  gap: 12px;
}

/* Onboarding looks like a form, not a toolbar */
.top{
  border-bottom: 1px solid var(--border);
  padding-bottom: 12px;
  margin-bottom: 0;
}

/* Improve readability + spacing */
.story{
  margin-top: 0;
  padding-top: 14px;
  min-height: 180px;
  font-size: 18px;
  line-height: 1.65;
  letter-spacing: .1px;
  border-top: 1px solid var(--border);
}

/* Choices feel like tappable mobile buttons */
.choiceBtn{
  padding: 18px 16px;
  font-size: 16px;
  line-height: 1.3;
  border-width: 1px;
  touch-action: manipulation;
}

/* Bigger cursor, slightly less aggressive */
.cursor{
  width: 8px;
}

/* Make the Age header responsive */
.age{
  font-size: clamp(34px, 8vw, 52px);
  font-weight: 800;
}

/* Meta text should never dominate on small screens */
.meta{
  max-width: 100%;
  font-size: 12px;
  opacity: .75;
}

/* Loading overlay becomes a bottom sheet (mobile-native) */
.overlay{
  background: rgba(255,255,255,.85);
  align-items: flex-end;
  justify-content: center;
  padding: 0 14px max(14px, env(safe-area-inset-bottom)) 14px;
}

.overlayBox{
  width: 100%;
  max-width: 980px;
  border: 1px solid var(--border);
  background: #fff;
  padding: 14px 14px;
  font-size: 14px;
}

/* Make spinner + dots line up nicely */
.loaderRow{
  display:flex;
  align-items:center;
  gap:10px;
  margin-top:8px;
}

/* ---------- Small screens ---------- */
@media (max-width: 640px){

  .window{
    padding: 12px;
    min-height: 92vh;
  }

  /* Stack inputs cleanly */
  .top{
    display: grid;
    grid-template-columns: 1fr;
    gap: 10px;
    align-items: stretch;
  }

  .field{
    min-width: 0;
  }

  input, select{
    font-size: 16px; /* stops iOS zoom-on-focus */
    padding: 12px 12px;
  }

  .startBtn{
    width: 100%;
    padding: 14px 12px;
    font-size: 16px;
  }

  .hud{
    flex-direction: column;
    align-items: flex-start;
    gap: 6px;
  }

  .meta{
    text-align: left;
  }

  /* Keep story readable and avoid huge empty space */
  .story{
    font-size: 17px;
    min-height: 160px;
  	max-height: 44vh;
	overflow: auto;
  }

  .choices{
    gap: 10px;
  }

  .choiceBtn{
    padding: 18px 14px;
    font-size: 16px;
  }
}
  </style>
</head>

<body>
  <div class="window" id="window">

    <div class="top" id="onboarding">
      <div class="field">
        <label>Gender</label>
        <select id="gender">
          <option value="female">female</option>
          <option value="male">male</option>
          <option value="unspecified">unspecified</option>
        </select>
      </div>

      <div class="field">
        <label>City of birth</label>
        <input id="city" value="London" />
      </div>

      <div class="field">
        <label>I want to start life…</label>
        <input id="desire" placeholder="free / famous / rich / strong" />
      </div>

      <button class="startBtn" id="start">Start Life</button>
    </div>

    <div class="hud">
      <div class="age" id="age">Age: 0</div>
      <div class="meta" id="meta">Choose wisely</div>
    </div>

    <div class="story" id="story">
      Fill in info and Press Start Life above.<span class="cursor">█</span>
    </div>

    <div class="choices">
      <button class="choiceBtn" id="a" disabled>A</button>
      <button class="choiceBtn" id="b" disabled>B</button>
    </div>

    <div class="error" id="error" style="display:none;"></div>
  </div>

  <div class="overlay hidden" id="loading">
  <div class="overlayBox">
    <div class="overlayTitle">Loading<span class="dots"></span></div>
    <div class="loaderRow">
      <div class="spinner"></div>
      <div>Generating next life moment<span class="dots"></span></div>
    </div>
  </div>
</div>

<script>
  // Backend base URL
  const API_BASE = "https://life-sim-production.up.railway.app";

	function getSessionId(){
  const key = "lifeSimSessionId";
  let id = localStorage.getItem(key);
  if(!id){
    id = (crypto?.randomUUID?.() || String(Date.now()) + "-" + Math.random().toString(16).slice(2));
    localStorage.setItem(key, id);
  }
  return id;
}
  // Random relationship names per new game (changes each time)
  const NAME_POOL = {
    mother: ["Clara","Amira","Leah","Maya","Jo","Ruth","Sofia","Nadia","Tess","Imani","Farah","Elena","Siobhan","Yasmin"],
    father: ["Hugh","Sam","Omar","Jai","Theo","Marcus","Ben","Ivo","Callum","Rafi","Noah","Alex","Elliot","Gabe"],
    guardian: ["Nina","Grace","Paul","Kari","Mo","Iris","Drew","Zara","Sana","Mina","Luca","Elle","Remy","Tariq"]
  };

  function pick(arr){ return arr[Math.floor(Math.random() * arr.length)]; }

  function makeRelationships(){
    const m = { name: pick(NAME_POOL.mother), role: "mother" };
    let f = { name: pick(NAME_POOL.father), role: "father" };
    let g = { name: pick(NAME_POOL.guardian), role: "guardian" };

    // de-dup names if random clash
    const used = new Set([m.name]);
    while(used.has(f.name)) f.name = pick(NAME_POOL.father);
    used.add(f.name);
    while(used.has(g.name)) g.name = pick(NAME_POOL.guardian);

    return [m, f, g];
  }

  const state = {
    session_id: getSessionId(),
	age: 0,
    gender: "female",
    city: "London",
    desire: "free",
    stats: { money:.5, stability:.5, status:.5, health:.5, stress:.5, freedom:.5, exposure:.5 },
    relationships: makeRelationships(),
    history: []
  };

  // track “first appearance” of each relationship name
  const seen = new Map(); // name -> true

  let currentScenario = null;
  let locked = false;

  const el = {
    gender: document.getElementById("gender"),
    city: document.getElementById("city"),
    desire: document.getElementById("desire"),
    start: document.getElementById("start"),
    age: document.getElementById("age"),
    meta: document.getElementById("meta"),
    story: document.getElementById("story"),
    a: document.getElementById("a"),
    b: document.getElementById("b"),
    error: document.getElementById("error"),
    loading: document.getElementById("loading"),
    onboarding: document.getElementById("onboarding")
  };

  function setError(msg){
    if(!msg){
      el.error.style.display = "none";
      el.error.textContent = "";
      return;
    }
    el.error.style.display = "block";
    el.error.textContent = msg;
  }

  function setLoading(on){
    locked = on;
    if(on) el.loading.classList.remove("hidden");
    else el.loading.classList.add("hidden");
  }

  function setButtonsDisabled(disabled){
    el.a.disabled = disabled;
    el.b.disabled = disabled;
  }

  function sleep(ms){ return new Promise(r => setTimeout(r, ms)); }

  // Ensure (role) shows ONLY the first time a person appears.
  // If the model includes “Name (role)” repeatedly, we strip it after first occurrence.
  function enforceRoleFirstAppearance(text){
    let out = String(text || "");

    for (const p of state.relationships) {
      const name = p.name;
      const role = p.role;

      // Normalize both "Name" and "Name (role)"
      // Rule: first time -> "Name (role)" ; subsequent -> "Name"
      const already = !!seen.get(name);

      if (!already) {
        // Ensure at least one "Name (role)" exists for first mention
        // Replace the first bare "Name" with "Name (role)"
        const reBare = new RegExp(`\\b${name}\\b(?!\\s*\\()`);
        out = out.replace(reBare, `${name} (${role})`);
        seen.set(name, true);

        // Now strip any additional "(role)" occurrences beyond the first
        const reRoleAll = new RegExp(`\\b${name}\\s*\\(${role}\\)`, "g");
        let first = true;
        out = out.replace(reRoleAll, (m) => {
          if (first) { first = false; return m; }
          return name;
        });
      } else {
        // Strip all role tags if already seen
        const reRole = new RegExp(`\\b${name}\\s*\$begin:math:text$\$\{role\}\\$end:math:text$`, "g");
        out = out.replace(reRole, name);
      }
    }

    return out;
  }

  // Typewriter render: slower (50% speed = 2x delay)
  async function typewriter(rawText, speed=26){
    setButtonsDisabled(true);

    const cursor = `<span class="cursor">█</span>`;

    // better spacing: add a blank line between clauses if text is long
    const text = String(rawText || "").replace(/\s+/g, " ").trim();

    el.story.innerHTML = cursor;
    let out = "";

    for(let i=0;i<text.length;i++){
      out += text[i];
      el.story.innerHTML = out + cursor;
      await sleep(speed);
    }

    el.story.innerHTML = out + cursor;
    setButtonsDisabled(false);
  }

  async function apiTurn(){
    const r = await fetch(API_BASE + "/api/turn", {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ state })
    });

    if(!r.ok){
      let msg = "turn_failed";
      try {
        const data = await r.json();
        msg = data?.message || data?.error || msg;
      } catch {
        const t = await r.text().catch(()=> "");
        if(t) msg = t;
      }
      throw new Error(msg);
    }

    return await r.json();
  }

  async function apiApply(effects){
    const r = await fetch(API_BASE + "/api/apply", {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ age: state.age, stats: state.stats, effects })
    });

    if(!r.ok){
      let msg = "apply_failed";
      try {
        const data = await r.json();
        msg = data?.message || data?.error || msg;
      } catch {
        const t = await r.text().catch(()=> "");
        if(t) msg = t;
      }
      throw new Error(msg);
    }

    return await r.json();
  }

  function renderChoices(scenario){
    // enforce "role only first appearance" in option labels too
    const aLabel = enforceRoleFirstAppearance(scenario.options[0].label);
    const bLabel = enforceRoleFirstAppearance(scenario.options[1].label);

    el.a.textContent = aLabel;
    el.b.textContent = bLabel;
  }

  async function startGame(){
    setError("");

    // New game → new random relationships + reset seen map
    state.relationships = makeRelationships();
    seen.clear();

    state.age = 0;
    state.history = [];
    state.stats = { money:.5, stability:.5, status:.5, health:.5, stress:.5, freedom:.5, exposure:.5 };

    state.gender = (el.gender.value || "unspecified").trim();
    state.city = (el.city.value || "London").trim();
    state.desire = (el.desire.value || "free").trim();

    el.meta.textContent = `${state.city.toUpperCase()} • I WANT TO BE ${state.desire.toUpperCase()}`;

    // Optional: hide onboarding after start
    el.onboarding.style.display = "none";

    setLoading(true);
    setButtonsDisabled(true);

    try{
	const { age_to, scenario, birth_stats, relationships } = await apiTurn();
	if (birth_stats) state.stats = birth_stats;
	if (relationships && relationships.length) state.relationships = relationships;
      state.age = age_to;
      currentScenario = scenario;

      el.age.textContent = `Age: ${state.age}`;

      // Stop loading BEFORE typewriter begins
      setLoading(false);

      const storyText = enforceRoleFirstAppearance(scenario.text);
      renderChoices(scenario);

      // 50% speed (slower)
      await typewriter(storyText, 26);

    }catch(e){
      setLoading(false);
      setError(`Start failed: ${e?.message || e}`);
      el.onboarding.style.display = "flex";
      setButtonsDisabled(false);
    }
  }

  async function choose(index){
    if(locked || !currentScenario) return;

    setError("");
    setLoading(true);
    setButtonsDisabled(true);

    try{
      const chosen = currentScenario.options[index];
      state.history.push(chosen.label);

      const applied = await apiApply(chosen.effects || {});
      state.stats = applied.next_stats;

      if(applied.died){
        setLoading(false);
        el.story.innerHTML = `You die at ${state.age}. Cause: ${(currentScenario.death_cause_hint || "complications")}.<span class="cursor">█</span>`;
        return;
      }

      const { age_to, scenario } = await apiTurn();
      state.age = age_to;
      currentScenario = scenario;

      el.age.textContent = `Age: ${state.age}`;

      // Stop loading BEFORE typewriter begins
      setLoading(false);

      const storyText = enforceRoleFirstAppearance(scenario.text);
      renderChoices(scenario);

      // 50% speed (slower)
      await typewriter(storyText, 26);

    }catch(e){
      setLoading(false);
      setError(`Turn failed: ${e?.message || e}`);
      setButtonsDisabled(false);
    }
  }

  el.start.addEventListener("click", startGame);
  el.a.addEventListener("click", () => choose(0));
  el.b.addEventListener("click", () => choose(1));
</script>
</body>
</html>
