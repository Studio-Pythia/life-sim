<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Life Simulator</title>

  <style>
    :root{
      --bg:#f6f6f6;
      --ink:#111;
      --muted:#444;
      --border:#111;
      --panel:#fff;
      --accent:#0000ee; /* classic link blue */
      --danger:#b00020;
    }

    *{ box-sizing:border-box; }

    body{
      margin:0;
      background:var(--bg);
      color:var(--ink);
      font-family: "Courier New", Courier, ui-monospace, Menlo, Monaco, Consolas;
      display:flex;
      align-items:center;
      justify-content:center;
      min-height:100vh;
      padding: max(14px, env(safe-area-inset-top)) max(14px, env(safe-area-inset-right))
              max(18px, env(safe-area-inset-bottom)) max(14px, env(safe-area-inset-left));
    }

    .window{
      width: 100%;
      max-width: 980px;
      background:var(--panel);
      border:1px solid var(--border);
      padding:14px;
      min-height: min(92vh, 860px);
      display:flex;
      flex-direction:column;
      gap:12px;
    }

    .top{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:end;
      border-bottom:1px solid var(--border);
      padding-bottom:12px;
      margin-bottom:0;
    }

    .field{
      flex:1;
      min-width:180px;
      display:flex;
      flex-direction:column;
      gap:6px;
    }

    label{
      font-size:12px;
      color:var(--muted);
    }

    input, select{
      padding:12px;
      border:1px solid var(--border);
      background:#fff;
      font-family: inherit;
      font-size:16px; /* prevents iOS zoom */
    }

    .startBtn{
      padding:14px 12px;
      border:1px solid var(--border);
      background:#fff;
      cursor:pointer;
      font-family: inherit;
      text-decoration:underline;
      width: min(220px, 100%);
    }

    .startBtn:hover{
      background:#f0f0f0;
    }

    .hud{
      display:flex;
      justify-content:space-between;
      align-items:baseline;
      gap:10px;
      margin-top:2px;
      flex-wrap:wrap;
    }

    .age{
      font-size: clamp(34px, 8vw, 52px);
      font-weight:800;
    }

    .meta{
      font-size:12px;
      color:var(--muted);
      text-align:right;
      max-width:100%;
      opacity:.75;
    }

    .story{
      border-top:1px solid var(--border);
      padding-top:14px;
      min-height:180px;
      font-size:18px;
      line-height:1.65;
      letter-spacing:.1px;
      white-space:pre-wrap;
    }

    .cursor{
      display:inline-block;
      width:8px;
      margin-left:3px;
      animation: blink 0.9s steps(1) infinite;
    }

    @keyframes blink{
      50%{ opacity:0; }
    }

    .choices{
      margin-top:4px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    .choiceBtn{
      width:100%;
      padding:18px 16px;
      border:1px solid var(--border);
      background:#fff;
      cursor:pointer;
      font-family: inherit;
      text-align:left;
      font-size:16px;
      line-height:1.3;
      touch-action: manipulation;
    }

    .choiceBtn:hover{ background:#f0f0f0; }
    .choiceBtn:disabled{ opacity:.35; cursor:not-allowed; }

    .error{
      margin-top:8px;
      color:var(--danger);
      font-size:13px;
    }

    /* Loading overlay -> bottom sheet */
    .overlay{
      position:fixed;
      inset:0;
      background:rgba(255,255,255,.85);
      display:flex;
      align-items:flex-end;
      justify-content:center;
      z-index:9999;
      padding: 0 14px max(14px, env(safe-area-inset-bottom)) 14px;
    }

    .overlayBox{
      border:1px solid var(--border);
      background:#fff;
      padding:14px 16px;
      font-size:14px;
      width:100%;
      max-width:980px;
    }

    .overlayTitle{
      font-weight:700;
      margin-bottom:8px;
      text-decoration:underline;
    }

    .hidden{
      display:none !important;
      pointer-events:none !important;
    }

    .hiddenBtn{
  display:none !important;
}

    .loaderRow{
      display:flex;
      align-items:center;
      gap:10px;
      margin-top:6px;
    }

    .spinner{
      width:14px;
      height:14px;
      border:2px solid #111;
      border-top-color: transparent;
      border-radius:999px;
      animation: spin .8s linear infinite;
    }

    @keyframes spin{
      to{ transform: rotate(360deg); }
    }

    .dots::after{
      content:"";
      display:inline-block;
      width:14px;
      text-align:left;
      animation: dots 1.2s steps(4,end) infinite;
    }

    @keyframes dots{
      0%{ content:""; }
      25%{ content:"."; }
      50%{ content:".."; }
      75%{ content:"..."; }
      100%{ content:""; }
    }

    @media (max-width: 640px){
      .top{
        display:grid;
        grid-template-columns:1fr;
        gap:10px;
        align-items:stretch;
      }

      .field{ min-width:0; }
      .startBtn{ width:100%; }

      .hud{
        flex-direction:column;
        align-items:flex-start;
        gap:6px;
      }

      .meta{ text-align:left; }

      .story{
        font-size:17px;
        min-height:160px;
      }
    }

    #playAgain{
      text-align:center;
      font-weight:700;
      letter-spacing:0.5px;
    }
  </style>
</head>

<body>
  <div class="window" id="window">

    <div class="top" id="onboarding">
      <div class="field">
        <label>Gender</label>
        <select id="gender">
          <option value="female">female</option>
          <option value="male">male</option>
        </select>
      </div>

      <div class="field">
        <label>City of birth</label>
        <input id="city" placeholder="e.g. Chicago" />
      </div>

      <div class="field">
        <label>I want to become…</label>
        <input id="desire" placeholder="e.g. famous / rich / free / a basketball player" />
      </div>

      <button class="startBtn" id="start" type="button">Start Life</button>
    </div>

    <div class="hud">
      <div class="age" id="age">Age: 0</div>
      <div class="meta" id="meta">CHOOSE WISELY</div>
    </div>

    <div class="story" id="story">
      Fill in info and Press Start Life above.<span class="cursor">█</span>
    </div>

    <div class="choices">
      <button class="choiceBtn" id="a" disabled>A</button>
      <button class="choiceBtn" id="b" disabled>B</button>
      <button class="choiceBtn hidden" id="playAgain" type="button">PLAY AGAIN</button>
    </div>

    <div class="error" id="error" style="display:none;"></div>
  </div>

  <div class="overlay hidden" id="loading">
    <div class="overlayBox">
      <div class="overlayTitle">Loading<span class="dots"></span></div>
      <div class="loaderRow">
        <div class="spinner"></div>
        <div class="loaderMsg">Generating next life moment<span class="dots"></span></div>
      </div>
    </div>
  </div>

<script>
  // ✅ Your Railway backend
  const API_BASE = "https://life-sim-production.up.railway.app";

  // ---- DOM ----
  const el = {
    gender: document.getElementById("gender"),
    city: document.getElementById("city"),
    desire: document.getElementById("desire"),
    start: document.getElementById("start"),
    age: document.getElementById("age"),
    meta: document.getElementById("meta"),
    story: document.getElementById("story"),
    a: document.getElementById("a"),
    b: document.getElementById("b"),
    playAgain: document.getElementById("playAgain"),
    error: document.getElementById("error"),
    loading: document.getElementById("loading"),
    loadingMsg: document.querySelector(".loaderMsg"),
    onboarding: document.getElementById("onboarding")
  };

  // ---- IDs ----
  function newRunId(){
    if (window.crypto && crypto.randomUUID) return crypto.randomUUID();
    return String(Date.now()) + "-" + Math.random().toString(16).slice(2);
  }

  function getSessionId(){
    const key = "lifeSimSessionId";
    let id = localStorage.getItem(key);
    if(!id){
      id = newRunId();
      localStorage.setItem(key, id);
    }
    return id;
  }

  // ---- State ----
  const state = {
    session_id: getSessionId(),
    run_id: newRunId(),
    age: 0,
    gender: "unspecified",
    city: "",
    desire: "",
    stats: { money:.5, stability:.5, status:.5, health:.5, stress:.5, freedom:.5, exposure:.5 },
    relationships: [],
    history: []
  };

  let currentScenario = null;
  let locked = false;

  // ---- Loader lines ----
  const loadLines = [
    "Generating next life moment…",
    "Calculating consequences…",
    "Locking the timeline…",
    "Spooling the next decade…",
    "Loading the moment…"
  ];
  let loadTimer = null;

  // ---- UI helpers ----
  function showPlayAgain(on){
    if(on) el.playAgain.classList.remove("hidden");
    else el.playAgain.classList.add("hidden");
  }

  function setError(msg){
    if(!msg){
      el.error.style.display = "none";
      el.error.textContent = "";
      return;
    }
    el.error.style.display = "block";
    el.error.textContent = msg;
  }

  function setLoading(on){
    locked = on;
    if(on){
      el.loading.classList.remove("hidden");
      let i = 0;
      el.loadingMsg.textContent = loadLines[i];
      loadTimer = setInterval(() => {
        i = (i + 1) % loadLines.length;
        el.loadingMsg.textContent = loadLines[i];
      }, 350);
    } else {
      el.loading.classList.add("hidden");
      if(loadTimer) clearInterval(loadTimer);
      loadTimer = null;
    }
  }
  function setRIP(age){
  el.age.textContent = `RIP AGE: ${age}`;
}

function showChoices(on){
  if(on){
    el.a.classList.remove("hiddenBtn");
    el.b.classList.remove("hiddenBtn");
  }else{
    el.a.classList.add("hiddenBtn");
    el.b.classList.add("hiddenBtn");
  }
}
  function setButtonsDisabled(disabled){
    el.a.disabled = disabled;
    el.b.disabled = disabled;
  }

  function sleep(ms){ return new Promise(r => setTimeout(r, ms)); }

  async function typewriter(text, speed=14){
    setButtonsDisabled(true);
    const cursor = `<span class="cursor">█</span>`;
    el.story.innerHTML = cursor;

    let out = "";
    for(let i=0;i<text.length;i++){
      out += text[i];
      el.story.innerHTML = out.replaceAll("\n", "<br>") + cursor;
      await sleep(speed);
    }
    el.story.innerHTML = out.replaceAll("\n", "<br>") + cursor;
    setButtonsDisabled(false);
  }

  function renderChoices(scenario){
    el.a.textContent = scenario.options[0].label;
    el.b.textContent = scenario.options[1].label;
  }

  function resetGameUI(){
  currentScenario = null;
  locked = false;

  state.run_id = newRunId();
  state.age = 0;
  state.history = [];
  state.relationships = [];
  state.stats = { money:.5, stability:.5, status:.5, health:.5, stress:.5, freedom:.5, exposure:.5 };

  el.age.textContent = "Age: 0";
  el.meta.textContent = "CHOOSE WISELY";
  el.story.innerHTML = `Fill in info and Press Start Life above.<span class="cursor">█</span>`;

  el.a.textContent = "A";
  el.b.textContent = "B";

  showChoices(true);        // ✅ bring A/B back
  setButtonsDisabled(true); // still disabled until start

  showPlayAgain(false);
  setError("");
  setLoading(false);
}

  // ---- API ----
  async function apiTurn(){
    const r = await fetch(API_BASE + "/api/turn", {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ state })
    });

    const json = await r.json().catch(()=> null);
    if(!r.ok){
      throw new Error(json?.message || json?.error || "turn_failed");
    }
    return json;
  }

  async function apiApply(effects){
    const r = await fetch(API_BASE + "/api/apply", {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({
        age: state.age,
        stats: state.stats,
        effects,
        death_cause_hint: currentScenario?.death_cause_hint || ""
      })
    });

    const json = await r.json().catch(()=> null);
    if(!r.ok){
      throw new Error(json?.error || "apply_failed");
    }
    return json;
  }

  async function apiEpilogue(cause){
    const r = await fetch(API_BASE + "/api/epilogue", {
      method: "POST",
      headers: { "Content-Type":"application/json" },
      body: JSON.stringify({
        age: state.age,
        gender: state.gender,
        city: state.city,
        desire: state.desire,
        relationships: state.relationships || [],
        history: state.history.slice(-30),
        cause
      })
    });

    const json = await r.json().catch(()=> null);
    if(!r.ok){
      return { text: `You die at ${state.age}. Cause: ${cause}.` };
    }
    return json;
  }

  // ---- Game ----
  async function startGame(){
    setError("");
    showPlayAgain(false);
    showChoices(true);

    // New run every start attempt
    state.run_id = newRunId();
    state.age = 0;
    state.history = [];
    state.relationships = [];
    state.stats = { money:.5, stability:.5, status:.5, health:.5, stress:.5, freedom:.5, exposure:.5 };

    state.gender = (el.gender.value || "unspecified").trim();
    state.city = (el.city.value || "").trim();
    state.desire = (el.desire.value || "").trim();

    if(!state.city || !state.desire){
      setError("Enter a city and what you want to be.");
      return;
    }

    el.meta.textContent = `${state.city.toUpperCase()} • I WANT TO BECOME ${state.desire.toUpperCase()}`;

    setLoading(true);
    setButtonsDisabled(true);

    try{
      const data = await apiTurn();

      if (data.birth_stats) state.stats = data.birth_stats;
      if (data.relationships && data.relationships.length === 3) state.relationships = data.relationships;

      state.age = data.age_to;
      currentScenario = data.scenario;

      el.age.textContent = `Age: ${state.age}`;
      renderChoices(currentScenario);

      setLoading(false); // stop loader before typing
      await typewriter(currentScenario.text, 14);
    }catch(e){
      setLoading(false);
      setError("Start failed: " + (e.message || "Model error"));
      setButtonsDisabled(true);
    }
  }

  async function choose(index){
    if(locked || !currentScenario) return;

    setError("");
    setLoading(true);
    setButtonsDisabled(true);

    try{
      const chosen = currentScenario.options[index];
      state.history.push(chosen.label);

      const applied = await apiApply(chosen.effects || {});
      state.stats = applied.next_stats;

      if(applied.died){
  setLoading(false);

  // ✅ Hide A/B forever on death screen
  showChoices(false);

  // ✅ RIP headline
  setRIP(state.age);

  const cause = (currentScenario.death_cause_hint || "complications").trim() || "complications";
  const ep = await apiEpilogue(cause);

  setButtonsDisabled(true);
  await typewriter(ep.text || `You die at ${state.age}. Cause: ${cause}.`, 14);

  showPlayAgain(true);
  return;
}

      const next = await apiTurn();

      if (next.relationships && next.relationships.length === 3) state.relationships = next.relationships;

      state.age = next.age_to;
      currentScenario = next.scenario;

      el.age.textContent = `Age: ${state.age}`;
      renderChoices(currentScenario);

      setLoading(false);
      await typewriter(currentScenario.text, 14);

    }catch(e){
      setLoading(false);
      setError("Turn failed: " + (e.message || "bad_request"));
      setButtonsDisabled(false);
    }
  }

  // ---- Events ----
  el.start.addEventListener("click", (e) => {
    e.preventDefault();
    startGame();
  });

  el.a.addEventListener("click", () => choose(0));
  el.b.addEventListener("click", () => choose(1));

  el.playAgain.addEventListener("click", () => {
    resetGameUI();
  });
</script>
</body>
</html>
