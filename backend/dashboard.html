<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Life Sim — Analytics</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;600;700&family=Newsreader:ital,wght@0,400;0,600;1,400&display=swap');

  * { margin: 0; padding: 0; box-sizing: border-box; }

  :root {
    --bg: #0a0a0c;
    --surface: #111114;
    --surface2: #18181c;
    --border: #2a2a30;
    --text: #e8e8ec;
    --dim: #6b6b78;
    --accent: #c8f740;
    --accent2: #40c8f7;
    --red: #f74040;
    --orange: #f7a040;
    --purple: #a040f7;
    --mono: 'JetBrains Mono', monospace;
    --serif: 'Newsreader', Georgia, serif;
  }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: var(--mono);
    font-size: 13px;
    line-height: 1.6;
    min-height: 100vh;
  }

  /* ─── HEADER ─── */
  .header {
    border-bottom: 1px solid var(--border);
    padding: 20px 32px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    position: sticky;
    top: 0;
    background: var(--bg);
    z-index: 100;
  }

  .header h1 {
    font-family: var(--serif);
    font-size: 20px;
    font-weight: 600;
    letter-spacing: -0.02em;
  }

  .header h1 span { color: var(--accent); }

  .db-status {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 11px;
    color: var(--dim);
  }

  .db-dot {
    width: 8px; height: 8px;
    border-radius: 50%;
    background: var(--red);
  }

  .db-dot.connected { background: var(--accent); }

  .refresh-btn {
    background: var(--surface2);
    border: 1px solid var(--border);
    color: var(--text);
    padding: 6px 14px;
    font-family: var(--mono);
    font-size: 11px;
    cursor: pointer;
    transition: all 0.15s;
  }

  .refresh-btn:hover { background: var(--border); }

  /* ─── LAYOUT ─── */
  .main {
    padding: 24px 32px;
    max-width: 1400px;
  }

  /* ─── METRIC CARDS ─── */
  .metrics-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 12px;
    margin-bottom: 28px;
  }

  .metric-card {
    background: var(--surface);
    border: 1px solid var(--border);
    padding: 16px 18px;
  }

  .metric-card .label {
    font-size: 10px;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: var(--dim);
    margin-bottom: 6px;
  }

  .metric-card .value {
    font-size: 28px;
    font-weight: 700;
    letter-spacing: -0.03em;
    color: var(--accent);
  }

  .metric-card .value.blue { color: var(--accent2); }
  .metric-card .value.orange { color: var(--orange); }
  .metric-card .value.red { color: var(--red); }
  .metric-card .value.purple { color: var(--purple); }

  .metric-card .sub {
    font-size: 10px;
    color: var(--dim);
    margin-top: 4px;
  }

  /* ─── SECTIONS ─── */
  .section {
    margin-bottom: 32px;
  }

  .section-title {
    font-family: var(--serif);
    font-size: 16px;
    font-weight: 600;
    margin-bottom: 14px;
    padding-bottom: 8px;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .section-title .count {
    font-family: var(--mono);
    font-size: 11px;
    color: var(--dim);
    background: var(--surface2);
    padding: 2px 8px;
  }

  /* ─── TABLES ─── */
  .table-wrap {
    overflow-x: auto;
  }

  table {
    width: 100%;
    border-collapse: collapse;
    font-size: 12px;
  }

  th {
    text-align: left;
    padding: 8px 12px;
    font-size: 10px;
    text-transform: uppercase;
    letter-spacing: 0.06em;
    color: var(--dim);
    border-bottom: 1px solid var(--border);
    background: var(--surface);
    position: sticky;
    top: 0;
  }

  td {
    padding: 8px 12px;
    border-bottom: 1px solid #1a1a1f;
    vertical-align: top;
  }

  tr:hover td { background: var(--surface); }

  .clickable { cursor: pointer; }
  .clickable:hover td { background: var(--surface2); }

  .tag {
    display: inline-block;
    padding: 1px 6px;
    font-size: 10px;
    background: var(--surface2);
    border: 1px solid var(--border);
    color: var(--dim);
  }

  .tag.alive { color: var(--accent); border-color: #2a3a10; }
  .tag.dead { color: var(--red); border-color: #3a1010; }

  td.age { font-weight: 600; color: var(--accent); }
  td.city { color: var(--accent2); }
  td.desire { color: var(--orange); font-style: italic; font-family: var(--serif); }
  td.cause { color: var(--red); }
  td.verdict { color: var(--dim); font-style: italic; font-family: var(--serif); font-size: 11px; }

  /* ─── TWO-COL LAYOUT ─── */
  .two-col {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 24px;
  }

  @media (max-width: 900px) {
    .two-col { grid-template-columns: 1fr; }
  }

  /* ─── CHART (canvas-based) ─── */
  .chart-container {
    background: var(--surface);
    border: 1px solid var(--border);
    padding: 16px;
    position: relative;
    height: 280px;
  }

  .chart-container canvas {
    width: 100% !important;
    height: 100% !important;
  }

  /* ─── PLAYER JOURNEY PANEL ─── */
  .journey-panel {
    background: var(--surface);
    border: 1px solid var(--border);
    padding: 20px;
    display: none;
  }

  .journey-panel.open { display: block; }

  .journey-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 16px;
  }

  .journey-header h3 {
    font-family: var(--serif);
    font-size: 18px;
  }

  .journey-close {
    background: none;
    border: 1px solid var(--border);
    color: var(--dim);
    width: 28px; height: 28px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    font-size: 14px;
  }

  .journey-close:hover { color: var(--text); border-color: var(--text); }

  .journey-meta {
    display: flex;
    gap: 20px;
    margin-bottom: 16px;
    font-size: 12px;
    color: var(--dim);
  }

  .journey-meta span { color: var(--text); }

  .journey-verdict {
    font-family: var(--serif);
    font-style: italic;
    color: var(--orange);
    margin-bottom: 16px;
    font-size: 14px;
    line-height: 1.5;
  }

  .journey-chart {
    height: 220px;
    margin-bottom: 16px;
    position: relative;
  }

  .timeline-event {
    padding: 10px 0;
    border-bottom: 1px solid #1a1a1f;
    display: grid;
    grid-template-columns: 60px 1fr auto;
    gap: 12px;
  }

  .timeline-age {
    font-weight: 700;
    color: var(--accent);
  }

  .timeline-text {
    font-size: 12px;
    line-height: 1.5;
    color: var(--dim);
  }

  .timeline-choice {
    font-size: 11px;
    color: var(--accent2);
    white-space: nowrap;
  }

  /* ─── SEARCH ─── */
  .search-bar {
    display: flex;
    gap: 8px;
    margin-bottom: 16px;
  }

  .search-bar input {
    flex: 1;
    background: var(--surface);
    border: 1px solid var(--border);
    color: var(--text);
    padding: 8px 14px;
    font-family: var(--mono);
    font-size: 12px;
    outline: none;
  }

  .search-bar input:focus { border-color: var(--accent); }

  .search-bar input::placeholder { color: #3a3a44; }

  .search-bar button {
    background: var(--accent);
    border: none;
    color: #000;
    padding: 8px 18px;
    font-family: var(--mono);
    font-size: 11px;
    font-weight: 600;
    cursor: pointer;
    text-transform: uppercase;
    letter-spacing: 0.04em;
  }

  .search-bar button:hover { opacity: 0.9; }

  /* ─── BAR CHART (CSS) ─── */
  .bar-row {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 6px;
  }

  .bar-label {
    width: 120px;
    text-align: right;
    font-size: 11px;
    color: var(--dim);
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .bar-track {
    flex: 1;
    height: 18px;
    background: var(--surface2);
    position: relative;
  }

  .bar-fill {
    height: 100%;
    background: var(--accent);
    transition: width 0.4s ease;
    position: relative;
  }

  .bar-fill .bar-value {
    position: absolute;
    right: 6px;
    top: 50%;
    transform: translateY(-50%);
    font-size: 10px;
    font-weight: 600;
    color: #000;
  }

  .bar-fill.small .bar-value {
    right: -30px;
    color: var(--dim);
  }

  /* ─── LOADING ─── */
  .loading {
    color: var(--dim);
    font-style: italic;
    padding: 20px;
  }

  .error-msg {
    color: var(--red);
    padding: 12px;
    background: #1a0a0a;
    border: 1px solid #3a1010;
    margin-bottom: 16px;
  }

  /* ─── TABS ─── */
  .tabs {
    display: flex;
    gap: 0;
    margin-bottom: 20px;
    border-bottom: 1px solid var(--border);
  }

  .tab {
    padding: 10px 20px;
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 0.06em;
    color: var(--dim);
    cursor: pointer;
    border-bottom: 2px solid transparent;
    transition: all 0.15s;
  }

  .tab:hover { color: var(--text); }
  .tab.active { color: var(--accent); border-bottom-color: var(--accent); }

  .tab-content { display: none; }
  .tab-content.active { display: block; }

  /* ─── SCROLLABLE ─── */
  .scroll-table {
    max-height: 400px;
    overflow-y: auto;
  }

  .scroll-table::-webkit-scrollbar { width: 6px; }
  .scroll-table::-webkit-scrollbar-track { background: var(--surface); }
  .scroll-table::-webkit-scrollbar-thumb { background: var(--border); }
</style>
</head>
<body>

<div class="header">
  <h1>Life Sim <span>Analytics</span></h1>
  <div style="display:flex;align-items:center;gap:16px">
    <div class="db-status">
      <div class="db-dot" id="dbDot"></div>
      <span id="dbLabel">connecting...</span>
    </div>
    <button class="refresh-btn" onclick="loadAll()">↻ Refresh</button>
  </div>
</div>

<div class="main">

  <!-- Metrics Row -->
  <div class="metrics-row" id="metricsRow">
    <div class="metric-card"><div class="label">Total Runs</div><div class="value" id="mTotalRuns">—</div></div>
    <div class="metric-card"><div class="label">Completed</div><div class="value blue" id="mCompleted">—</div></div>
    <div class="metric-card"><div class="label">Avg Death Age</div><div class="value orange" id="mAvgAge">—</div></div>
    <div class="metric-card"><div class="label">Youngest Death</div><div class="value red" id="mYoungest">—</div></div>
    <div class="metric-card"><div class="label">Oldest Death</div><div class="value purple" id="mOldest">—</div></div>
  </div>

  <!-- Tabs -->
  <div class="tabs">
    <div class="tab active" data-tab="overview">Overview</div>
    <div class="tab" data-tab="journeys">Player Journeys</div>
    <div class="tab" data-tab="patterns">Patterns</div>
    <div class="tab" data-tab="export">Export</div>
  </div>

  <!-- TAB: Overview -->
  <div class="tab-content active" id="tab-overview">
    <div class="two-col">
      <div class="section">
        <div class="section-title">Top Desires <span class="count" id="desireCount"></span></div>
        <div id="desireBars"></div>
      </div>
      <div class="section">
        <div class="section-title">Cities <span class="count" id="cityCount"></span></div>
        <div id="cityBars"></div>
      </div>
    </div>

    <div class="section">
      <div class="section-title">Recent Runs</div>
      <div class="table-wrap scroll-table" id="recentTable">
        <p class="loading">Loading...</p>
      </div>
    </div>
  </div>

  <!-- TAB: Journeys -->
  <div class="tab-content" id="tab-journeys">
    <div class="search-bar">
      <input type="text" id="journeySearch" placeholder="Enter run_id to explore a player's full journey...">
      <button onclick="searchJourney()">Load Journey</button>
    </div>

    <div class="journey-panel" id="journeyPanel">
      <div class="journey-header">
        <h3 id="journeyTitle">—</h3>
        <button class="journey-close" onclick="closeJourney()">×</button>
      </div>
      <div class="journey-meta" id="journeyMeta"></div>
      <div class="journey-verdict" id="journeyVerdict"></div>
      <div class="journey-chart">
        <canvas id="journeyChart"></canvas>
      </div>
      <div id="journeyTimeline"></div>
    </div>

    <div class="section" id="allRunsSection">
      <div class="section-title">All Completed Runs</div>
      <div class="table-wrap scroll-table" id="allRunsTable">
        <p class="loading">Loading...</p>
      </div>
    </div>
  </div>

  <!-- TAB: Patterns -->
  <div class="tab-content" id="tab-patterns">
    <div class="two-col">
      <div class="section">
        <div class="section-title">Choice Distribution by Age</div>
        <div class="chart-container">
          <canvas id="choiceChart"></canvas>
        </div>
      </div>
      <div class="section">
        <div class="section-title">Average Stats Across All Lives</div>
        <div class="chart-container">
          <canvas id="statsChart"></canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- TAB: Export -->
  <div class="tab-content" id="tab-export">
    <div class="section">
      <div class="section-title">Raw Data Export</div>
      <p style="color:var(--dim);margin-bottom:16px;">Download analytics data as JSON for external analysis.</p>
      <div style="display:flex;gap:10px;flex-wrap:wrap;">
        <button class="refresh-btn" onclick="exportData('summary')">Summary JSON</button>
        <button class="refresh-btn" onclick="exportData('deaths')">Death Board JSON</button>
        <button class="refresh-btn" onclick="exportData('cities')">City Stats JSON</button>
        <button class="refresh-btn" onclick="exportData('choices')">Choice Patterns JSON</button>
        <button class="refresh-btn" onclick="exportData('stats')">Stat Averages JSON</button>
      </div>
    </div>
  </div>

</div>

<!-- Chart.js from CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<script>
const API = window.location.origin;

// ─── Tab switching ───
document.querySelectorAll('.tab').forEach(tab => {
  tab.addEventListener('click', () => {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    tab.classList.add('active');
    document.getElementById('tab-' + tab.dataset.tab).classList.add('active');
  });
});

// ─── API calls ───
async function api(path) {
  const res = await fetch(API + path);
  if (!res.ok) throw new Error(`${res.status} ${res.statusText}`);
  return res.json();
}

// ─── Load everything ───
async function loadAll() {
  try {
    const summary = await api('/api/analytics/summary');
    renderSummary(summary);
  } catch (err) {
    console.error('Summary load failed:', err);
  }

  try {
    const cities = await api('/api/analytics/cities');
    renderCities(cities);
  } catch (err) { console.error('Cities load failed:', err); }

  try {
    const deaths = await api('/api/analytics/deaths?sort=newest&limit=50');
    renderAllRuns(deaths);
  } catch (err) { console.error('Deaths load failed:', err); }

  try {
    const choices = await api('/api/analytics/choices');
    renderChoiceChart(choices);
  } catch (err) { console.error('Choices load failed:', err); }

  try {
    const stats = await api('/api/analytics/stat-averages');
    renderStatsChart(stats);
  } catch (err) { console.error('Stats load failed:', err); }
}

// ─── Render summary metrics ───
function renderSummary(s) {
  const dot = document.getElementById('dbDot');
  const label = document.getElementById('dbLabel');

  if (s.db_connected) {
    dot.classList.add('connected');
    label.textContent = 'PostgreSQL connected';
  } else {
    dot.classList.remove('connected');
    label.textContent = 'in-memory only';
  }

  document.getElementById('mTotalRuns').textContent = s.total_runs ?? s.total_events ?? '—';
  document.getElementById('mCompleted').textContent = s.completed_runs ?? '—';
  document.getElementById('mAvgAge').textContent = s.avg_death_age ?? '—';
  document.getElementById('mYoungest').textContent = s.min_death_age ?? '—';
  document.getElementById('mOldest').textContent = s.max_death_age ?? '—';

  // Desire bars
  const desires = s.top_desires || [];
  document.getElementById('desireCount').textContent = desires.length + ' unique';
  const maxD = Math.max(...desires.map(d => d.count), 1);
  document.getElementById('desireBars').innerHTML = desires.slice(0, 15).map(d => {
    const pct = (d.count / maxD * 100).toFixed(0);
    const small = pct < 20 ? 'small' : '';
    return `<div class="bar-row">
      <div class="bar-label" title="${d.desire}">${d.desire}</div>
      <div class="bar-track"><div class="bar-fill ${small}" style="width:${pct}%"><span class="bar-value">${d.count}</span></div></div>
    </div>`;
  }).join('');

  // Recent runs table
  if (s.recent_runs) {
    renderRecentTable(s.recent_runs);
  }
}

function renderRecentTable(runs) {
  if (!runs.length) {
    document.getElementById('recentTable').innerHTML = '<p class="loading">No runs yet.</p>';
    return;
  }
  document.getElementById('recentTable').innerHTML = `<table>
    <tr><th>Run ID</th><th>City</th><th>Desire</th><th>Gender</th><th>Death Age</th><th>Cause</th><th>Started</th></tr>
    ${runs.map(r => `<tr class="clickable" onclick="loadJourney('${r.run_id}')">
      <td><code>${(r.run_id || '').slice(0, 12)}…</code></td>
      <td class="city">${r.city || '—'}</td>
      <td class="desire">${r.desire || '—'}</td>
      <td>${r.gender || '—'}</td>
      <td class="age">${r.death_age ?? '<span class="tag alive">alive</span>'}</td>
      <td class="cause">${r.death_cause || '—'}</td>
      <td style="color:var(--dim)">${r.started_at ? new Date(r.started_at).toLocaleDateString() : '—'}</td>
    </tr>`).join('')}
  </table>`;
}

function renderCities(cities) {
  if (!cities.length) return;
  document.getElementById('cityCount').textContent = cities.length + ' cities';
  const maxC = Math.max(...cities.map(c => parseInt(c.total_runs)), 1);
  document.getElementById('cityBars').innerHTML = cities.slice(0, 15).map(c => {
    const pct = (parseInt(c.total_runs) / maxC * 100).toFixed(0);
    const small = pct < 20 ? 'small' : '';
    return `<div class="bar-row">
      <div class="bar-label" title="${c.city}">${c.city}</div>
      <div class="bar-track"><div class="bar-fill ${small}" style="width:${pct}%;background:var(--accent2)"><span class="bar-value">${c.total_runs} (avg ${c.avg_death_age || '?'})</span></div></div>
    </div>`;
  }).join('');
}

function renderAllRuns(deaths) {
  if (!deaths.length) {
    document.getElementById('allRunsTable').innerHTML = '<p class="loading">No completed runs yet.</p>';
    return;
  }
  document.getElementById('allRunsTable').innerHTML = `<table>
    <tr><th>Run ID</th><th>City</th><th>Desire</th><th>Age</th><th>Cause</th><th>Verdict</th></tr>
    ${deaths.map(r => `<tr class="clickable" onclick="loadJourney('${r.run_id}')">
      <td><code>${(r.run_id || '').slice(0, 12)}…</code></td>
      <td class="city">${r.city || '—'}</td>
      <td class="desire">${r.desire || '—'}</td>
      <td class="age">${r.death_age ?? '—'}</td>
      <td class="cause">${r.death_cause || '—'}</td>
      <td class="verdict">${r.verdict || '—'}</td>
    </tr>`).join('')}
  </table>`;
}

// ─── Choice chart ───
let choiceChartInst = null;
function renderChoiceChart(data) {
  if (!data.length) return;
  const ctx = document.getElementById('choiceChart').getContext('2d');
  if (choiceChartInst) choiceChartInst.destroy();

  choiceChartInst = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: data.map(d => 'Age ' + d.age),
      datasets: [
        {
          label: 'Choice A',
          data: data.map(d => parseInt(d.chose_a)),
          backgroundColor: '#c8f74088',
          borderColor: '#c8f740',
          borderWidth: 1,
        },
        {
          label: 'Choice B',
          data: data.map(d => parseInt(d.chose_b)),
          backgroundColor: '#40c8f788',
          borderColor: '#40c8f7',
          borderWidth: 1,
        },
      ],
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { labels: { color: '#6b6b78', font: { family: "'JetBrains Mono'" } } } },
      scales: {
        x: { stacked: true, ticks: { color: '#6b6b78', maxRotation: 45 }, grid: { color: '#1a1a1f' } },
        y: { stacked: true, ticks: { color: '#6b6b78' }, grid: { color: '#1a1a1f' } },
      },
    },
  });
}

// ─── Stat averages chart ───
let statsChartInst = null;
function renderStatsChart(data) {
  if (!data.length) return;
  const ctx = document.getElementById('statsChart').getContext('2d');
  if (statsChartInst) statsChartInst.destroy();

  const colors = {
    money: '#c8f740', stability: '#40c8f7', status: '#f7a040',
    health: '#40f7a0', stress: '#f74040', freedom: '#a040f7', exposure: '#f740c8'
  };

  const datasets = Object.keys(colors).map(key => ({
    label: key,
    data: data.map(d => parseFloat(d[key])),
    borderColor: colors[key],
    backgroundColor: 'transparent',
    borderWidth: 1.5,
    pointRadius: 0,
    tension: 0.3,
  }));

  statsChartInst = new Chart(ctx, {
    type: 'line',
    data: { labels: data.map(d => d.age), datasets },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { labels: { color: '#6b6b78', font: { family: "'JetBrains Mono'", size: 10 } } } },
      scales: {
        x: { title: { display: true, text: 'Age', color: '#6b6b78' }, ticks: { color: '#6b6b78' }, grid: { color: '#1a1a1f' } },
        y: { min: 0, max: 1, ticks: { color: '#6b6b78' }, grid: { color: '#1a1a1f' } },
      },
    },
  });
}

// ─── Player Journey ───
let journeyChartInst = null;

function searchJourney() {
  const id = document.getElementById('journeySearch').value.trim();
  if (id) loadJourney(id);
}

document.getElementById('journeySearch').addEventListener('keydown', (e) => {
  if (e.key === 'Enter') searchJourney();
});

async function loadJourney(runId) {
  // Switch to journeys tab
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
  document.querySelector('[data-tab="journeys"]').classList.add('active');
  document.getElementById('tab-journeys').classList.add('active');

  document.getElementById('journeySearch').value = runId;

  try {
    const journey = await api('/api/analytics/journey/' + runId);
    if (!journey || !journey.run) {
      alert('Journey not found. Make sure the database is connected.');
      return;
    }
    renderJourney(journey);
  } catch (err) {
    console.error('Journey load failed:', err);
    alert('Failed to load journey: ' + err.message);
  }
}

function renderJourney(j) {
  const panel = document.getElementById('journeyPanel');
  panel.classList.add('open');

  const r = j.run;
  document.getElementById('journeyTitle').textContent =
    `${r.city || 'Unknown'} — "${r.desire || '?'}"`;

  document.getElementById('journeyMeta').innerHTML = `
    Gender: <span>${r.gender || '?'}</span> ·
    Died at: <span style="color:var(--accent)">${r.death_age ?? 'alive'}</span> ·
    Cause: <span style="color:var(--red)">${r.death_cause || '—'}</span> ·
    Turns: <span>${j.turns.length}</span>
  `;

  document.getElementById('journeyVerdict').textContent = r.verdict || '';

  // Stat arc chart
  if (j.stat_arc && j.stat_arc.length > 0) {
    const ctx = document.getElementById('journeyChart').getContext('2d');
    if (journeyChartInst) journeyChartInst.destroy();

    const colors = {
      money: '#c8f740', stability: '#40c8f7', status: '#f7a040',
      health: '#40f7a0', stress: '#f74040', freedom: '#a040f7', exposure: '#f740c8'
    };

    const datasets = Object.keys(colors).map(key => ({
      label: key,
      data: j.stat_arc.map(s => s[key]),
      borderColor: colors[key],
      backgroundColor: 'transparent',
      borderWidth: 2,
      pointRadius: 3,
      pointBackgroundColor: colors[key],
      tension: 0.3,
    }));

    journeyChartInst = new Chart(ctx, {
      type: 'line',
      data: { labels: j.stat_arc.map(s => 'Age ' + s.age), datasets },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { labels: { color: '#6b6b78', font: { family: "'JetBrains Mono'", size: 10 } } } },
        scales: {
          x: { ticks: { color: '#6b6b78' }, grid: { color: '#1a1a1f' } },
          y: { min: 0, max: 1, ticks: { color: '#6b6b78' }, grid: { color: '#1a1a1f' } },
        },
      },
    });
  }

  // Timeline
  const timeline = document.getElementById('journeyTimeline');
  timeline.innerHTML = j.turns.map(t => {
    const text = t.scenario_text || '';
    const preview = text.length > 200 ? text.slice(0, 200) + '…' : text;
    return `<div class="timeline-event">
      <div class="timeline-age">Age ${t.age}</div>
      <div class="timeline-text">${preview}</div>
      <div class="timeline-choice">${t.chosen ? (t.chosen + ': ' + (t.chosen_label || '')) : '—'}</div>
    </div>`;
  }).join('');

  // Scroll to panel
  panel.scrollIntoView({ behavior: 'smooth', block: 'start' });
}

function closeJourney() {
  document.getElementById('journeyPanel').classList.remove('open');
}

// ─── Export ───
async function exportData(type) {
  const endpoints = {
    summary: '/api/analytics/summary',
    deaths: '/api/analytics/deaths?limit=1000',
    cities: '/api/analytics/cities',
    choices: '/api/analytics/choices',
    stats: '/api/analytics/stat-averages',
  };

  try {
    const data = await api(endpoints[type]);
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `lifesim-${type}-${new Date().toISOString().slice(0, 10)}.json`;
    a.click();
    URL.revokeObjectURL(url);
  } catch (err) {
    alert('Export failed: ' + err.message);
  }
}

// ─── Init ───
loadAll();
</script>

</body>
</html>
